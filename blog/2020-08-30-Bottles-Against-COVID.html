<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Ethan McAuliffe</title><meta name="description" content="My personal website and blog"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/674b4048aafd2ab13367.css" as="style"/><link rel="stylesheet" href="/_next/static/css/674b4048aafd2ab13367.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6d60fbe6f04b36912b39.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6d60fbe6f04b36912b39.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-90a60b87fd0d5fc150f2.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-7a0ed9b54ee413b64c69.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2f2e40eeee33a42dbc14.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5BpostName%5D-16fec599cd3f1ade44b5.js" defer=""></script><script src="/_next/static/SyBJKaoNCzre2I37ptT8g/_buildManifest.js" defer=""></script><script src="/_next/static/SyBJKaoNCzre2I37ptT8g/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="Post_container__39vXa"><div class="Post_backButton__2By7j"><a href="/blog">◀ All Posts</a></div><h1>Bottles Against COVID-19</h1><p>Lacking a summer job thanks to the COVID-19 pandemic, my sister and I wanted to make the most of this situation by helping those around us. So, we created <a href="https://bottlesagainstcovid.org">BottlesAgainstCOVID.org</a>. This not only made it easy for us to collect empty bottles from our neighbours, but easy for anyone else to sign up and do the same. The intent is for all proceeds to be donated to charity. In our case, we raised over $3k for St. Joe&#x27;s Hospital in Toronto.</p><h2>How it all started</h2><p>During the COVID-19 pandemic people have been spending a lot more time at home. With this, alcohol consumption has increased greatly. In the USA, <a href="https://apnews.com/c407ecb931c6c528b4cceb0ecc216f0c">some studies suggest</a> a 55% year-over-year increase in alcohol sales from this time last year. <a href="https://www.ccsa.ca/sites/default/files/2020-04/CCSA-NANOS-Alcohol-Consumption-During-COVID-19-Report-2020-en.pdf">Surveys show</a> that Canada is no different. While this &quot;coping mechanism&quot; is <a href="http://www.euro.who.int/__data/assets/pdf_file/0010/437608/Alcohol-and-COVID-19-what-you-need-to-know.pdf">ill-advised by the WHO</a>, it seems that people do not seem to care all that much.</p><p>It was my sister&#x27;s idea to turn this into something positive. She figured that all the empty bottles sitting at people&#x27;s homes could be returned to the Beer Store, and the proceeds could be donated to charity. Her charity of choice was the <a href="https://secure3.convio.net/stjoca/site/SPageNavigator/westendheroes_home.html">St. Joe&#x27;s Hospital COVID-19 fund</a>. She created a <a href="https://calendly.com/">calendly</a> page and posted on a few local Facebook pages. Pickup would be completely contactless – registrants would simply leave their empties on their front porch or curb. News of the initiative spread fast, and hundreds of people signed up.</p><p>On the first pickup day we realized there was a problem. We had <em>a lot</em> more support than expected. So much so it was overwhelming. Bottle pickup, which was estimated to take 3 hours, took 8. In one day, we collected more than 4000 bottles from over 50 houses. While it was great to see the community rally behind our cause, this amount was overwhelming. It took 6 full days of bottle sorting and returning to get through this amount. The day after we finished was another scheduled pickup day. We needed a way to limit our intake without limiting our impact.</p><p><a href="/assets/img/bottles-against-covid/day-1-bottle-drive-cropped.jpg"><img src="/assets/img/bottles-against-covid/day-1-bottle-drive-cropped.jpg" alt="Day one of bottle collections"/></a></p><p>So, I started working on a website. The goal was to create something that could limit the amount of collections by number of bottles (instead of number of pickups) and allow others to join in on our solution. By allowing anyone to create their own bottle drive, we reduce the overall number of people leaving their homes to return empties and empower others to help.</p><h2>How the website works</h2><p>The front end is client rendered and communicates directly with the Flask back end using the <code>fetch</code> API. Some pages (home page, FAQ page) are hand-written in HTML with a little bit of JS. Yarn handles package management for the front end.</p><p>The Flask back end is mostly RESTful, with one caveat: the server handles session management using the &quot;session&quot; library built into Flask. The back end communicates with the database via the mongoengine library. Poetry handles back end package management.</p><p>The database in use is MongoDB. Before this project, I had no experience with MongoDB. Everything I know, I learned from building this website. The decision to chose MongoDB came as a recommendation from a friend to give NoSQL a try.</p><h3>Searching for existing bottle drives</h3><p>Searching for drives is likely the most used feature of the website. As such, it is important the search feature be accurate and intuitive. Therefore, the search function is on the main web page, and a user can use either geolocation or a postal code to query for drives in their area.</p><p><a href="/assets/img/bottles-against-covid/home-page.png"><img src="/assets/img/bottles-against-covid/home-page.png" alt="home page"/></a></p><p>Clicking the &quot;Search by location&quot; button calls the <code>locationSearch()</code> function. This first checks for the presence of the HTML geolocation API, preventing null errors if the feature is unsupported.</p><pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title hljs-function">locationSearch</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">geolocation</span>) {
      <span class="hljs-comment">/*important parts of function go here*/</span>
    }
}
</code></pre><p>Next, it calls this API, triggering a prompt for the user to allow access to their location. </p><pre><code class="hljs language-js">navigator.<span class="hljs-property">geolocation</span>.<span class="hljs-title hljs-function">getCurrentPosition</span>(<span class="hljs-comment">/*callback function*/</span>)
</code></pre><p>The callback function here formats the <code>longitude</code> and <code>latitude</code> results into a URL query string and redirects the user to the search results page.</p><pre><code class="hljs language-js">navigator.<span class="hljs-property">geolocation</span>.<span class="hljs-title hljs-function">getCurrentPosition</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> queryString = <span class="hljs-string">`lat=<span class="hljs-subst">${result.coords.latitude}</span>&amp;long=<span class="hljs-subst">${result.coords.longitude}</span>&amp;postal=false`</span>
  <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">assign</span>(<span class="hljs-string">`/search?<span class="hljs-subst">${queryString}</span>`</span>)
})
</code></pre><p>The &quot;Search by location&quot; button becomes disabled if at any point the function fails to return an appropriate geolocation. Often this occurs when the user chooses to block the website from accessing their precise location. Disabling the button prevents future ineffective search attempts and makes it clear that the user should instead search via postal code.</p><pre><code class="hljs language-js">navigator.<span class="hljs-property">geolocation</span>.<span class="hljs-title hljs-function">getCurrentPosition</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-comment">/*query string and redirect part from above*/</span>
}, <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;locSearch&quot;</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>)

</code></pre><p>Putting this all together (and compacting some of the code), results in the function&#x27;s final form:</p><pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title hljs-function">locationSearch</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">geolocation</span>) {
        navigator.<span class="hljs-property">geolocation</span>.<span class="hljs-title hljs-function">getCurrentPosition</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">assign</span>(<span class="hljs-string">`/search?lat=<span class="hljs-subst">${result.coords.latitude}</span>&amp;long=<span class="hljs-subst">${result.coords.longitude}</span>&amp;postal=false`</span>), <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;locSearch&quot;</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>)
    }
}
</code></pre><p>Postal code searches are first vetted through an input regex statement. This restricts the valid input to that of any 6-digit Canadian postal code with or without a separating space. This statement (taken from <a href="https://stackoverflow.com/questions/15774555/efficient-regex-for-canadian-postal-code-function/46761018">here</a>) is quite strict and goes beyond just number/letter alternating pattern. Most interestingly, it follows the Canada Post regulations of not containing letters which can be confused for numbers (I, O, Q, Z, ...). </p><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;postalCode&quot;</span> 
  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;K1A 0A9&quot;</span> 
  <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;^([ABCEGHJ-NPRSTVXY]|[abceghj-nprstvxy])[0-9]([ABCEGHJ-NPRSTV-Z]|[abceghj-nprstv-z]) ?[0-9]([ABCEGHJ-NPRSTV-Z]|[abceghj-nprstv-z])[0-9]$&quot;</span>
&gt;</span>
</code></pre><p>After pressing the search button, the <code>postalSearch()</code> function validates the input and queries a public database for postal code information. Also, disabling the search button and changing the cursor prevents repeated queries to the database while waiting for a response. The <code>value.replace(&#x27; &#x27;, &#x27;&#x27;)</code> line removes the (optional) space between the two parts of a postal code.</p><pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title hljs-function">postalSearch</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> postalCode = <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalCode&quot;</span>)
    <span class="hljs-keyword">if</span> (postalCode.<span class="hljs-title hljs-function">checkValidity</span>() &amp;&amp; postalCode.<span class="hljs-property">value</span> !== <span class="hljs-string">&quot;&quot;</span>) {
        <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>
        <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">&quot;wait&quot;</span>
        <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;https://geocoder.ca/?json=1&amp;getpolygon=1&amp;postal=&quot;</span> + postalCode.<span class="hljs-property">value</span>.<span class="hljs-title hljs-function">replace</span>(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>))
            .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result.<span class="hljs-title hljs-function">json</span>())
    }
}
</code></pre><p>The geocoder API returns a polygon representing the area covered by the postal code. The function takes this polygon and generates a URL query string. The query includes a Boolean signifying that the search used a postal code. Finally, the function redirects the user to their requested search results.</p><p>The final function looks like this:</p><pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title hljs-function">postalSearch</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> postalCode = <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalCode&quot;</span>)
    <span class="hljs-keyword">if</span> (postalCode.<span class="hljs-title hljs-function">checkValidity</span>() &amp;&amp; postalCode.<span class="hljs-property">value</span> !== <span class="hljs-string">&quot;&quot;</span>) {
        <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>
        <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">&quot;wait&quot;</span>
        <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;https://geocoder.ca/?json=1&amp;getpolygon=1&amp;postal=&quot;</span> + postalCode.<span class="hljs-property">value</span>.<span class="hljs-title hljs-function">replace</span>(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>))
            .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result.<span class="hljs-title hljs-function">json</span>())
            .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
                <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>
                <span class="hljs-variable hljs-language">document</span>.<span class="hljs-title hljs-function">getElementById</span>(<span class="hljs-string">&quot;postalButton&quot;</span>).<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">&quot;auto&quot;</span>
                <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">assign</span>(<span class="hljs-string">`/search?poly=<span class="hljs-subst">${value.boundary}</span>&amp;postal=true`</span>)
            })
    }
}
</code></pre><p>Upon loading the <code>LocationSearch</code> page, the React component fetches database results by passing the query to the underlying API. State then updates to store the response.</p><pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">LocationSearch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title hljs-class hljs-inherited">React.Component</span> {
  <span class="hljs-comment">/*...*/</span>
  <span class="hljs-title hljs-function">componentDidMount</span>(<span class="hljs-params"></span>) {
      <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">`/api/search<span class="hljs-subst">${<span class="hljs-variable hljs-language">this</span>.props.location.search}</span>`</span>)
          .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result.<span class="hljs-title hljs-function">json</span>())
          .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> <span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">setState</span>({ <span class="hljs-attr">response</span>: response }))
          .<span class="hljs-title hljs-function">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable hljs-language">console</span>.<span class="hljs-title hljs-function">log</span>(error))
  }
  <span class="hljs-comment">/*...*/</span>
}
</code></pre><p>Under the hood, the API parses the query string. The code converts the postal code polygon coordinates into a GeoJSON polygon when required. Of note here is that GeoJSON requires coordinates to be in <code>[long, lat]</code> format instead of the provided <code>[lat, long]</code>. Next, the built-in geo search capabilities of MongoDB become useful. The program queries the MongoDB database for existing bottle drive polygons which intersect with the searcher&#x27;s GPS location or postal code area. Bottle drive operators define their pickup polygon when they create an account. The web page will show multiple listings if multiple drives are in the searcher&#x27;s area.</p><p><a href="/assets/img/bottles-against-covid/search-page.png"><img src="/assets/img/bottles-against-covid/search-page.png" alt="search results"/></a></p><p>Also, for drives to show up in the search results, the bottle drive operator must have initialized a drive. Bottle drives with no drives will not show up. However, bottle drives with no <em>active</em> drives <em>will</em> appear. This means a bottle drive operator is working in the area, but nothing is available just yet. Drive deactivation occurs automatically when at capacity or if the date of said drive has passed. Perhaps there will be new drives in the future, so the searcher can view the page to bookmark/share accordingly.</p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">SearchForDrivesApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">try</span>:
            loc = <span class="hljs-literal">None</span>
            <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&quot;postal&quot;</span>) == <span class="hljs-string">&quot;true&quot;</span>:
                polyResult = request.args.get(<span class="hljs-string">&quot;poly&quot;</span>).split(<span class="hljs-string">&quot;,&quot;</span>)
                loc = {
                    <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Polygon&quot;</span>,
                    <span class="hljs-string">&quot;coordinates&quot;</span>: [[]],
                }
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(polyResult)-<span class="hljs-number">1</span>,<span class="hljs-number">2</span>):
                    loc[<span class="hljs-string">&quot;coordinates&quot;</span>][<span class="hljs-number">0</span>].append([<span class="hljs-built_in">float</span>(polyResult[i+<span class="hljs-number">1</span>]),<span class="hljs-built_in">float</span>(polyResult[i])])
                loc[<span class="hljs-string">&quot;coordinates&quot;</span>][<span class="hljs-number">0</span>].append(loc[<span class="hljs-string">&quot;coordinates&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]) <span class="hljs-comment"># GeoJSON polygons must end with their starting coordinate</span>
            <span class="hljs-keyword">else</span>:
                loc = [<span class="hljs-built_in">float</span>(request.args.get(<span class="hljs-string">&quot;long&quot;</span>)) , <span class="hljs-built_in">float</span>(request.args.get(<span class="hljs-string">&quot;lat&quot;</span>))]
            drives = User.objects(geo_region__geo_intersects=loc, drives__not__size=<span class="hljs-number">0</span>)
            driveList = []
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> drives <span class="hljs-keyword">or</span> [<span class="hljs-literal">None</span>]:
                driveList.append({
                    <span class="hljs-string">&quot;name&quot;</span>:i[<span class="hljs-string">&quot;name&quot;</span>],
                    <span class="hljs-string">&quot;link_code&quot;</span>:i[<span class="hljs-string">&quot;link_code&quot;</span>],
                    <span class="hljs-string">&quot;header&quot;</span>:i[<span class="hljs-string">&quot;header&quot;</span>],
                })
            <span class="hljs-keyword">return</span>(jsonify(driveList))
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> InternalServerError
</code></pre><h3>Handling bottle drive sign-ups</h3><p>The website redirects the searcher to the individual drive page upon clicking through on the search result card. </p><p><a href="/assets/img/bottles-against-covid/pickup-initial-page.jpg"><img src="/assets/img/bottles-against-covid/pickup-initial-page.jpg" alt="drive page"/></a></p><p>Here the user will see the drive pickup area, the time of day bottle pickup occurs, and the charity specified by the bottle drive operator. With the address search feature, they can begin the process of signing up for a bottle pickup.</p><p>All this data comes from a get request with the 5-character link code matching that of the current web page (ex. <a href="https://bottlesagainstcovid.org/XXf3d">bottlesagainstcovid.org/XXf3d</a> has a link code of <code>XXf3d</code>).</p><pre><code class="hljs language-js"><span class="hljs-title hljs-function">componentDidMount</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;/api/&quot;</span> + <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">link_code</span>)
        .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-keyword">return</span> response.<span class="hljs-title hljs-function">json</span>()
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) {
                <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">replace</span>(<span class="hljs-string">&quot;/404&quot;</span>)
            }
        })
        <span class="hljs-comment">/*...*/</span>
}
</code></pre><p>On the server side, Flask uses the 5-character <code>link_code</code> in conjunction with the current date to query the MongoDB database for drives the operator is running.</p><pre><code class="hljs language-python"><span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            pickupInfo = PickupInfo.objects(link_code__exact=link_code, date__gte=datetime.now()).order_by(<span class="hljs-string">&#x27;date&#x27;</span>)
            <span class="hljs-comment"># ...</span>
</code></pre><p>Each drive object has a <code>created_by</code> field which links to a <code>user</code> object. The <code>user</code> object stores info on the bottle drive operator. The response requires the operator&#x27;s name, their pickup region polygon, their preferred pickup times (morning/afternoon/evening), and their header message, which will display the charity they intend to donate funds to.</p><pre><code class="hljs language-python"><span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self, link_code</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># ...</span>
        userInfo = User.objects.get(<span class="hljs-built_in">id</span>=pickupInfo[<span class="hljs-number">0</span>].created_by.<span class="hljs-built_in">id</span>)
        pickupObj = {
            <span class="hljs-string">&quot;drive_name&quot;</span>:userInfo.name,
            <span class="hljs-string">&quot;pickup_times&quot;</span>: userInfo.pickup_times,
            <span class="hljs-string">&quot;dates_and_crates_left&quot;</span>: [],
            <span class="hljs-string">&quot;geo_region&quot;</span>: userInfo.geo_region,
            <span class="hljs-string">&quot;header&quot;</span>:userInfo.header
        }
        <span class="hljs-comment"># ...</span>
</code></pre><p>Next, the code iterates through all the <em>active</em> drives returned as <code>pickupInfo</code>. This loop appends a tuple with the date of each active drive and the capacity of bottles they have remaining at the time of the query (limit - current amount) to the <code>dates_and_crates_left</code> key of the <code>pickupObj</code>. The final step is returning <code>pickupObj</code>.</p><pre><code class="hljs language-python"><span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            pickupInfo = PickupInfo.objects(link_code__exact=link_code, date__gte=datetime.now()).order_by(<span class="hljs-string">&#x27;date&#x27;</span>)
            userInfo = User.objects.get(<span class="hljs-built_in">id</span>=pickupInfo[<span class="hljs-number">0</span>].created_by.<span class="hljs-built_in">id</span>)
            pickupObj = {
                <span class="hljs-string">&quot;drive_name&quot;</span>:userInfo.name,
                <span class="hljs-string">&quot;pickup_times&quot;</span>: userInfo.pickup_times,
                <span class="hljs-string">&quot;dates_and_crates_left&quot;</span>: [],
                <span class="hljs-string">&quot;geo_region&quot;</span>: userInfo.geo_region,
                <span class="hljs-string">&quot;header&quot;</span>:userInfo.header
            }
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> pickupInfo <span class="hljs-keyword">or</span> [<span class="hljs-literal">None</span>]:
                <span class="hljs-keyword">if</span> i.active == <span class="hljs-literal">True</span>:
                    pickupObj[<span class="hljs-string">&quot;dates_and_crates_left&quot;</span>].append((i[<span class="hljs-string">&quot;date&quot;</span>].strftime(<span class="hljs-string">&quot;%Y-%m-%d&quot;</span>), i.crates_limit-i[<span class="hljs-string">&quot;crates&quot;</span>]))
            <span class="hljs-keyword">return</span> jsonify(pickupObj)
        <span class="hljs-comment"># ...</span>
</code></pre><p>Before signing up, the user sees the pickup region as an SVG drawn onto the map. This feature uses the <code>latLngToPixel()</code> function provided as a part of the <a href="https://pigeon-maps.js.org/">pigeon-maps</a> library. Using a dynamic map with an SVG instead of a static image is advantageous because it allows user interaction (panning &amp; zooming).</p><p>This function maps each geo-coordinate in the geoJSON polygon to a corresponding pixel on the map.</p><pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title hljs-function">Polygon</span>(<span class="hljs-params">{ mapState: { width, height }, latLngToPixel, coordsArray, colour }</span>) {

    <span class="hljs-keyword">let</span> coords = <span class="hljs-string">&quot;&quot;</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; coordsArray.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">let</span> latLngPixels = <span class="hljs-title hljs-function">latLngToPixel</span>([coordsArray[i][<span class="hljs-number">1</span>], coordsArray[i][<span class="hljs-number">0</span>]])
        coords += <span class="hljs-string">`<span class="hljs-subst">${latLngPixels[<span class="hljs-number">0</span>]}</span>,<span class="hljs-subst">${latLngPixels[<span class="hljs-number">1</span>]}</span> `</span>
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{width}</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{height}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fill:</span> <span class="hljs-attr">colour</span>, <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0.4</span>, <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span> }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">polygon</span> <span class="hljs-attr">points</span>=<span class="hljs-string">{coords}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span>
    )
}
</code></pre><p>A library called <a href="https://github.com/mapbox/polylabel">polylabel</a> determines the center point of this map. This library aims to find the &quot;visual&quot; centre of the polygon and avoids issues caused by irregular shapes. Usage is as simple as passing the entire geoJSON coordinate array as a parameter. The result is a 2-element array.</p><pre><code class="hljs language-js"><span class="hljs-keyword">let</span> center = <span class="hljs-title hljs-function">polylabel</span>(result.<span class="hljs-property">geo_region</span>.<span class="hljs-property">coordinates</span>)
</code></pre><p>To sign up for a bottle drive, the user first searches for their address. <a href="https://www.npmjs.com/package/nominatim-browser">Nominatim</a> matches this query with the Open Street Map (OSM) address database.</p><p>This &quot;search address first&quot; method allows for verification that the address is eligible for pickup. The <a href="https://www.npmjs.com/package/robust-point-in-polygon">robust-point-in-polygon</a> library means we can check that the geo-coordinates of the searched address fall inside the pickup region. This method also ensures no errors in street name spellings that could make pickup difficult.</p><p>The website blocks users from completing further sign-up steps if they are not within the specified region.</p><p><a href="/assets/img/bottles-against-covid/failed-address.png"><img src="/assets/img/bottles-against-covid/failed-address.png" alt="failed search"/></a></p><p>The searched address also appears on the pickup region map so the user can visually see if the address is correct and whether they fall inside the pickup region. The first few form fields also appear.</p><p><a href="/assets/img/bottles-against-covid/address-and-name.jpg"><img src="/assets/img/bottles-against-covid/address-and-name.jpg" alt="post sign up search"/></a></p><p>After selecting a date, the rest of the form fields appear. </p><p><a href="/assets/img/bottles-against-covid/rest-of-fields.png"><img src="/assets/img/bottles-against-covid/rest-of-fields.png" alt="rest of form fields"/></a></p><p>Here the user can note how many boxes of bottles they would like to donate. Individually, these fields must be greater than or equal to zero. Together, their sum must be less than the limit. The front end only sends the sum back to the server. Separating the fields encourages users to follow the restrictions for pickups (ex. no cans). </p><p>Using <a href="https://www.hcaptcha.com/">hCaptcha</a> blocks any possibility of bots filling out the form. It also provides the opportunity to pay back Wikimedia who works with OSM to provide map services for free. All funds generated from using hCaptcha are automatically donated to Wikimedia. Successful completion of the hCaptcha field stores a token in <code>state</code>.</p><p>The <code>state</code> object stores each field of the form as it is being filled out. Submitting the form calls the <code>onSubmit()</code> method. </p><pre><code class="hljs language-js"><span class="hljs-title hljs-function">onSubmit</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">disabled</span> === <span class="hljs-literal">true</span>) {
        <span class="hljs-comment">/*...*/</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">validateInput</span>() === <span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">let</span> myHeaders = <span class="hljs-keyword">new</span> <span class="hljs-title hljs-class">Headers</span>();
        myHeaders.<span class="hljs-title hljs-function">append</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>);

        <span class="hljs-keyword">const</span> signupData = {
            <span class="hljs-string">&quot;details&quot;</span>: {
                <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">name</span>,
                <span class="hljs-string">&quot;homeAddress&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">address</span>,
                <span class="hljs-string">&quot;neighbourhood&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">neighbourhood</span>,
                <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">email</span>,
                <span class="hljs-string">&quot;crates&quot;</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">twelvePack</span>) + <span class="hljs-built_in">parseInt</span>(<span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">sixPack</span>) + <span class="hljs-built_in">parseInt</span>(<span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">beerBottles</span>),
                <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">message</span>,
            },
            <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">dates_and_crates_left</span>[<span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">selectedDate</span>.<span class="hljs-title hljs-function">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>)[<span class="hljs-number">1</span>]][<span class="hljs-number">0</span>],
            <span class="hljs-string">&quot;token&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hCaptcha_token</span>
        }
        
        <span class="hljs-keyword">const</span> requestOptions = {
            <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
            <span class="hljs-attr">headers</span>: myHeaders,
            <span class="hljs-attr">body</span>: <span class="hljs-variable hljs-constant">JSON</span>.<span class="hljs-title hljs-function">stringify</span>(signupData),
            <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;follow&#x27;</span>,
        };

        <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">`/api/<span class="hljs-subst">${<span class="hljs-variable hljs-language">this</span>.state.link_code}</span>`</span>, requestOptions)
            <span class="hljs-comment">/*...*/</span>
    }
}
</code></pre><p>Assuming valid input, the code first constructs the <code>signupData</code> object. This object uses info stored in <code>state</code>. Next, the program sends a <code>post</code> request to the <code>/api/{link_code}</code> endpoint. This is the same URL which the drive info was fetched from in the <code>componentDidMount()</code> method.</p><p>Server-side, the first operation is parsing the json into a python dictionary.</p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">SignupApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-comment"># ... get request code shown earlier ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            body = request.get_json()
            <span class="hljs-comment"># ...</span>
</code></pre><p>Authentication of the hCaptcha token must happen server-side for proper protection against bots. Client-side captcha authentication can be overridden, defeating its sole purpose. Here the back end redirects the token sent by the client to hCaptcha&#x27;s servers. The <a href="https://requests.readthedocs.io/en/master/">requests</a> library handles this. The request returns <code>{ success: True }</code> for valid tokens and <code>{ success: False }</code> for everything else (expired or invalid). In the case of an invalid token, the server throws an <code>InvalidTokenError</code>, breaking the <code>try-except</code> block.</p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">SignupApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ...</span>
            token = body.get(<span class="hljs-string">&quot;token&quot;</span>)
            data = { <span class="hljs-string">&#x27;secret&#x27;</span>: current_app.config[<span class="hljs-string">&quot;HCAPTCHA_SECRET_KEY&quot;</span>], <span class="hljs-string">&#x27;response&#x27;</span>: token }
            response = requests.post(url=<span class="hljs-string">&quot;https://hcaptcha.com/siteverify&quot;</span>, data=data)
            <span class="hljs-keyword">if</span> response.json()[<span class="hljs-string">&quot;success&quot;</span>] == <span class="hljs-literal">False</span> :
                <span class="hljs-keyword">raise</span> InvalidTokenError
            <span class="hljs-comment"># ...</span>
        <span class="hljs-keyword">except</span> InvalidTokenError:
            <span class="hljs-keyword">raise</span> InvalidTokenError
        <span class="hljs-comment"># ...</span>
</code></pre><p>The next step is querying the MongoDB database to access the object representing the requested bottle drive. This means the <code>link_code</code> and <code>date</code> match that sent in the post request.</p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">SignupApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ...</span>
            pickupInfo = PickupInfo.objects.get(link_code__exact=link_code, date__exact=body[<span class="hljs-string">&quot;date&quot;</span>], active=<span class="hljs-literal">True</span>)
            <span class="hljs-comment">#must query to determine uniqueness as it is required on a per-date basis</span>
            <span class="hljs-keyword">if</span> pickupInfo.addresses.<span class="hljs-built_in">filter</span>(homeAddress=body.get(<span class="hljs-string">&quot;details&quot;</span>).get(<span class="hljs-string">&quot;homeAddress&quot;</span>)).count() &gt; <span class="hljs-number">0</span>:
                <span class="hljs-keyword">raise</span> NotUniqueError
            pickupAddresses = PickupAddresses(**body.get(<span class="hljs-string">&quot;details&quot;</span>))
            pickupInfo.update(push__addresses=pickupAddresses, inc__crates=body.get(<span class="hljs-string">&quot;details&quot;</span>).get(<span class="hljs-string">&quot;crates&quot;</span>))
            <span class="hljs-comment"># ...</span>
</code></pre><p>On line 8 the code checks to make sure the user has not already registered for a pickup on this date. This prevents someone from accidentally filling up the capacity of a certain date when they only intended to edit their previous sign up info. Unfortunately, an edit system is not implemented. The user can save their extra bottles and sign up for the next pickup date. Most, however, just put their extra boxes out anyway. We still picked them up.</p><p>After passing all these validation checks, the <code>details</code> key of <code>body</code> unwraps into a <code>PickupAddresses</code> object. The program stores this object in the database. Using <code>push__addresses</code> and <code>inc__crates</code> avoids a race condition. A race condition (or race hazard) is the name for when a computer tries to do two things at the same time. For example, if two users try to sign up for the same bottle drive at the same time. With some exceptions, computers can only work on one thing at a time. Without proper handling, the computer may store the first address in the database and then immediately overwrite it with the second address. This would mean a loss of data. The first user, despite signing up properly, will not have their information recorded and thus will not have their bottles picked up. Pushing and incrementing prevents this by simply telling the computer to add information to the database instead of specifying <em>where</em> in the database to add information.</p><p>Finally, the program compares the number of signed up crates to the designated limit. Reaching the limit automatically switches the drive&#x27;s <code>active</code> field to <code>False</code> preventing further sign ups.</p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">SignupApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self, link_code</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># ...</span>
            <span class="hljs-comment">#check if the max number of crates has been reached</span>
            pickupInfo = PickupInfo.objects(<span class="hljs-built_in">id</span>=pickupInfo.<span class="hljs-built_in">id</span>).no_cache()
            <span class="hljs-keyword">if</span>(pickupInfo[<span class="hljs-number">0</span>].crates&gt;=pickupInfo[<span class="hljs-number">0</span>].crates_limit):
                pickupInfo.update(active=<span class="hljs-literal">False</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre><h3>Handling new bottle drive operators</h3><p>A key feature of <a href="https://bottlesagainstcovid.org">BottlesAgainstCOVID.org</a> is the ability for others to easily create their own bottle drives. While it would be much easier to program just the &quot;regular&quot; sign up, opening the service up to others allows more communities to get involved in the fight against COVID-19.</p><p>New bottle drive operators sign up at <a href="https://bottlesagainstcovid.org/signup">bottlesagainstcovid.org/signup</a>. Here operators complete the usual fields (name, email, password) as well as draw a pickup region on the map. </p><p><a href="/assets/img/bottles-against-covid/operator-fields-empty.jpg"><img src="/assets/img/bottles-against-covid/operator-fields-empty.jpg" alt="pickup sign up page"/></a></p><p>The text fields work similarly to those on the regular sign up page; the <code>state</code> object stores field data and updates with each edit using the <code>handleInputChange()</code> method. A special case here is when the input is a checkbox instead of a text field.</p><pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">Register</span> <span class="hljs-keyword">extends</span> <span class="hljs-title hljs-class hljs-inherited">React.Component</span> {
    <span class="hljs-comment">/*...*/</span>
    <span class="hljs-title hljs-function">handleInputChange</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>;
        <span class="hljs-keyword">let</span> value;
        <span class="hljs-keyword">if</span> (target.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;checkbox&#x27;</span>) {
            value = target.<span class="hljs-property">checked</span>;
        } <span class="hljs-keyword">else</span> {
            value = target.<span class="hljs-property">value</span>;
        }
        <span class="hljs-keyword">const</span> name = target.<span class="hljs-property">name</span>;
        <span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">setState</span>({
            [name]: value
        });
    }
    <span class="hljs-comment">/*...*/</span>
    <span class="hljs-title hljs-function">render</span>(<span class="hljs-params"></span>){
        <span class="hljs-keyword">return</span> (
            <span class="hljs-comment">/*...*/</span>
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;pickup-signup-input&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Your name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{this.state.name}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{this.handleInputChange}</span> <span class="hljs-attr">required</span> /&gt;</span></span>
            <span class="hljs-comment">/*...*/</span>
        )
    }
    <span class="hljs-comment">/*...*/</span>
}
</code></pre><p>The most complex feature on this page is the pickup region drawing apparatus. Here it is in action:</p><video controls="" muted="" allowfullscreen="" loop=""><source src="/assets/img/bottles-against-covid/draw-region.mp4" type="video/mp4"/></video><p>The <a href="https://urbica.github.io/react-map-gl-draw/">@urbica/react-map-gl-draw</a> library does nearly all the heavy lifting here. Everything works so long as configuration of the <code>&lt;MapGL&gt;</code> and <code>&lt;Draw&gt;</code> components match the examples on the library&#x27;s website. Notably the &quot;draw region&quot; control is external. This is because, despite being able to draw multiple polygons, the library only returns the state of the most recently drawn one. To solve this issue, the sign-up page restricts an operator&#x27;s ability to draw multiple polygons.</p><p>The most significant difficulty with this library was the implementation of 3rd party map tiling services. MapBox builds <code>&lt;MapGL&gt;</code> and closely links it to their services. Their free tier requires an API key and thus an account to use. OSM is a truly free alternative. The <code>mapStyle</code> object was the most challenging part to figure out as examples are essentially non-existent. This is how to implement a 3rd party tiling service with <a href="https://www.npmjs.com/package/react-map-gl">react-map-gl</a>:</p><pre><code class="hljs language-js"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">Map</span> <span class="hljs-keyword">extends</span> <span class="hljs-title hljs-class hljs-inherited">React.Component</span> {
    <span class="hljs-comment">/*...*/</span>
    <span class="hljs-title hljs-function">constructor</span>(<span class="hljs-params">props</span>) {
        <span class="hljs-comment">/*...*/</span>
        <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span> = {
            <span class="hljs-comment">/*...*/</span>
            <span class="hljs-attr">viewport</span>: {
                <span class="hljs-attr">width</span>: <span class="hljs-string">&#x27;100%&#x27;</span>,
                <span class="hljs-attr">height</span>: <span class="hljs-number">400</span>,
                <span class="hljs-attr">latitude</span>: <span class="hljs-number">43.6532</span>,
                <span class="hljs-attr">longitude</span>: -<span class="hljs-number">79.3832</span>,
                <span class="hljs-attr">zoom</span>: <span class="hljs-number">2</span>
            }
        }
    }

    <span class="hljs-title hljs-function">render</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">/*...*/</span>
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MapGL</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{this.props.style}</span>
                <span class="hljs-attr">onViewportChange</span>=<span class="hljs-string">{(viewport)</span> =&gt;</span> this.setState({ viewport })}
                mapStyle={mapStyle}
                {...this.state.viewport}
            &gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Draw</span>
                /*<span class="hljs-attr">...</span>*/
                /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">MapGL</span>&gt;</span></span>
        <span class="hljs-comment">/*...*/</span>
        )
    }
}

<span class="hljs-keyword">const</span> mapStyle = {
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-number">8</span>,
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;OSM Liberty&quot;</span>,
  <span class="hljs-string">&quot;metadata&quot;</span>: {
    <span class="hljs-string">&quot;maputnik:license&quot;</span>: <span class="hljs-string">&quot;https://github.com/maputnik/osm-liberty/blob/gh-pages/LICENSE.md&quot;</span>,
    <span class="hljs-string">&quot;maputnik:renderer&quot;</span>: <span class="hljs-string">&quot;mbgljs&quot;</span>
  },
  <span class="hljs-string">&quot;sources&quot;</span>: {
    <span class="hljs-string">&quot;osm a&quot;</span>: {
      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>,
      <span class="hljs-string">&quot;tiles&quot;</span>: [<span class="hljs-string">&quot;https://a.tile.openstreetmap.org/{z}/{x}/{y}.png&quot;</span>],
      <span class="hljs-string">&quot;minzoom&quot;</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">&quot;maxzoom&quot;</span>: <span class="hljs-number">19</span>
    },
    <span class="hljs-string">&quot;osm b&quot;</span>: {
      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>,
      <span class="hljs-string">&quot;tiles&quot;</span>: [<span class="hljs-string">&quot;https://b.tile.openstreetmap.org/{z}/{x}/{y}.png&quot;</span>],
      <span class="hljs-string">&quot;minzoom&quot;</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">&quot;maxzoom&quot;</span>: <span class="hljs-number">19</span>
    },
    <span class="hljs-string">&quot;osm c&quot;</span>: {
      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>,
      <span class="hljs-string">&quot;tiles&quot;</span>: [<span class="hljs-string">&quot;https://c.tile.openstreetmap.org/{z}/{x}/{y}.png&quot;</span>],
      <span class="hljs-string">&quot;minzoom&quot;</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">&quot;maxzoom&quot;</span>: <span class="hljs-number">19</span>
    }
  },
  <span class="hljs-string">&quot;layers&quot;</span>: [
    { <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;A osm&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;osm a&quot;</span> },
    { <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;B osm&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;osm b&quot;</span> },
    { <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;C osm&quot;</span>, <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;raster&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;osm c&quot;</span> }
  ],
  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;osm-liberty&quot;</span>
}

</code></pre><p>Server-side, the fundamental principles are the same as when a user signs up for pickup. The front end sends a post request with the form information and the back end stores this in a database. Things are unique, however, with regards to the <code>password</code> and <code>link_code</code> fields.</p><p>Anyone with a sliver of security knowledge should know storing passwords in plain text is an awful idea. It is not only a liability in the event of a hack, it is also a liability in that the service owners can see user passwords at any time. People often re-use passwords which means a malicious party could use BottlesAgainstCOVID.org take control of more important accounts (email, banking, etc.).</p><p>The current answer to this is storing salted and hashed passwords. </p><p>Hashing is the process of doing complex math equations that cannot be undone. This transforms the password into a seemingly random jumble of characters. The process is, however, not random as the same input will produce the same output every time. An example of an irreversible math operation is XOR.</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1</mn><mo>⊕</mo><mn>1</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">1 \oplus 1 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span></div><p>... but ...</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>0</mn><mo>⊕</mo><mn>0</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0 \oplus 0 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span></div><p>So, given <em>just</em> the result of <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span>, it is impossible to work backwards and determine whether both inputs were <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span> or <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span></span></span></span></span>.</p><p>With bcrypt, this supposedly irreversible process repeats numerous times making it even more resource intensive to try and reverse the hashing operation. Even the most powerful supercomputers would take thousands of years to decrypt a single password.</p><p>Salting a password means adding some random chunk of data to the inputted user password. This means that hackers cannot compare stored passwords with known hashes. For example, the bcrypt hash of &quot;<code>hunter2</code>&quot; (no salting) is:</p><pre><code class="hljs language-perl"><span class="hljs-string">&quot;$2b$10$3I4yPjW4IjTWnLe5IlCELePPPRfchtfn8mBcrLZxJl3rw.j6dpP7u&quot;</span>
</code></pre><p>A hacker could check for any accounts where the stored password value is this hash and know that user&#x27;s password without needing to reverse the hash algorithm. Salting adds in some random text so that the hash for &quot;<code>hunter2</code>&quot; becomes something else.</p><p>Implementing this with <a href="http://mongoengine.org/">mongoengine</a> and <a href="https://flask-bcrypt.readthedocs.io/en/latest/">flask_bcrypt</a> libraries looks like this:</p><pre><code class="hljs language-python"><span class="hljs-comment"># User model declaration</span>
<span class="hljs-comment"># This is an outline of what the user object looks like in the MongoDB database</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">from</span> flask_bcrypt <span class="hljs-keyword">import</span> generate_password_hash <span class="hljs-comment"># ...</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">User</span>(db.Document): <span class="hljs-comment"># class User extends db.Document</span>
    name = db.StringField(required=<span class="hljs-literal">True</span>)
    email = db.EmailField(required=<span class="hljs-literal">True</span>, unique=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># minimum length of a password is 6 characters</span>
    password = db.StringField(required=<span class="hljs-literal">True</span>, min_length=<span class="hljs-number">6</span>)
    geo_region = db.PolygonField(required=<span class="hljs-literal">True</span>)
    pickup_times = db.ListField(db.BooleanField(), required=<span class="hljs-literal">True</span>)
    header = db.StringField()
    link_code = db.StringField(required=<span class="hljs-literal">True</span>, unique=<span class="hljs-literal">True</span>)
    drives = db.ListField(db.ReferenceField(<span class="hljs-string">&#x27;PickupInfo&#x27;</span>, reverse_delete_rule=db.PULL))
    <span class="hljs-comment"># hash_password() is a method of the User class meaning all objects of type &quot;User&quot; can call this method on themselves</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">hash_password</span>(<span class="hljs-params">self</span>):
        self.password = generate_password_hash(self.password).decode(<span class="hljs-string">&#x27;utf8&#x27;</span>)
    <span class="hljs-comment"># ...</span>
</code></pre><pre><code class="hljs language-python"><span class="hljs-comment"># Flask post request</span>
<span class="hljs-comment"># This is called when a post request is sent to the &quot;bottlesagainstcovid.org/api/auth/register&quot; endpoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">RegisterApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
 <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">try</span>:
        body = request.get_json()
        user =  User(**body.get(<span class="hljs-string">&quot;details&quot;</span>))
        <span class="hljs-comment"># Passwords are hashed as soon as they are received</span>
        user.hash_password()
    <span class="hljs-comment"># ...</span>
</code></pre><p>Here the <code>hash_password()</code> method does all the salting and hashing work. A secret environment file initialized as part of <code>flask_bcrypt</code> contains the salt. Note that this salt <em>should</em> be a different, randomly generated string for every user.</p><pre><code class="hljs language-python"><span class="hljs-comment"># in the main app.py flask file</span>
<span class="hljs-keyword">from</span> flask_bcrypt <span class="hljs-keyword">import</span> Bcrypt
<span class="hljs-comment"># ...</span>
app.config.from_envvar(<span class="hljs-string">&#x27;ENV_FILE_LOCATION&#x27;</span>)
<span class="hljs-comment"># ...</span>
bcrypt = Bcrypt(app)
<span class="hljs-comment"># ...</span>
</code></pre><p>It is so easy to implement that there&#x27;s <strong>no excuse</strong> for storing passwords in plain text. It is also important to note all transfers of data from the front end to the back end are secure through forced use of HTTPS.</p><p>The next step is generating the bottle drive operator&#x27;s unique <code>link_code</code>. </p><pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">RegisterApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
 <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># ...</span>
        user.generate_link_code()
        user.save()
        session[<span class="hljs-string">&#x27;userId&#x27;</span>] = <span class="hljs-built_in">str</span>(user.<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;/list&quot;</span>)
    <span class="hljs-keyword">except</span> FieldDoesNotExist:
        <span class="hljs-keyword">raise</span> SchemaValidationError
    <span class="hljs-keyword">except</span> NotUniqueError:
        <span class="hljs-keyword">raise</span> EmailAlreadyExistsError
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> InternalServerError
</code></pre><pre><code class="hljs language-python"><span class="hljs-comment"># generate_link_code() method defined in the User class declaration</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">User</span>(db.Document):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">generate_link_code</span>(<span class="hljs-params">self</span>):
        good = <span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_&quot;</span>
        code = <span class="hljs-string">&quot;&quot;</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
            code += choice(good)
        <span class="hljs-keyword">if</span> (enchant.<span class="hljs-type">Dict</span>(<span class="hljs-string">&quot;en_US&quot;</span>).check(code) == <span class="hljs-literal">True</span>):<span class="hljs-comment">#make sure the code is not an english word</span>
            self.generate_link_code()
        <span class="hljs-keyword">try</span>:
            User.objects.get(link_code = code)<span class="hljs-comment">#throws an error if no object with the same link_code exits</span>
            self.generate_link_code()
        <span class="hljs-keyword">except</span> DoesNotExist:
            self.link_code = code
    <span class="hljs-comment"># ...</span>
</code></pre><p>The post request calls the <code>generate_link_code()</code> method. This method randomly picks 5 characters from 63 different URL safe options. It is important that the characters are URL safe to avoid hex values in the URL which make the links ugly. Next, the program checks to make sure the random collection of 5 characters is not a word (to completely avoid any profanity). There is also a check to make sure no other bottle drive operator has the same <code>link_code</code>. However, the chances of this happening are very low.</p><p>Calculating the number of possible permutations given a 5-character sample from a 63-character set gives:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mn>63</mn><mo stretchy="false">!</mo></mrow><mrow><mo stretchy="false">(</mo><mn>63</mn><mo>−</mo><mn>5</mn><mo stretchy="false">)</mo><mo stretchy="false">!</mo></mrow></mfrac><mo>=</mo><mn>843</mn><mtext> </mtext><mn>461</mn><mtext> </mtext><mn>640</mn></mrow><annotation encoding="application/x-tex">P = \frac{63!}{(63-5)!} = 843\:461\:640</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.30744em;vertical-align:-0.936em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">63</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">5</span><span class="mclose">)!</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">63</span><span class="mclose">!</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">843</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">461</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">640</span></span></span></span></span></div><p>Subtracting the number of 5 letter English words (according to <a href="https://www.quora.com/How-many-5-letter-words-exist/answer/Tom-Crosley-1">this source</a>) gives us:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>843</mn><mtext> </mtext><mn>461</mn><mtext> </mtext><mn>640</mn><mo>−</mo><mn>15</mn><mtext> </mtext><mn>108</mn><mo>=</mo><mn>843</mn><mtext> </mtext><mn>446</mn><mtext> </mtext><mn>532</mn></mrow><annotation encoding="application/x-tex">843\:461\:640 - 15\:108 = 843\:446\:532</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">843</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">461</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">640</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">15</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">108</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">843</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">446</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">532</span></span></span></span></span></div><p>This means that the odds of a collision occurring, given <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathnormal">x</span></span></span></span></span> accounts created is:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mfrac><mrow><mn>843</mn><mtext> </mtext><mn>446</mn><mtext> </mtext><mn>532</mn><mo stretchy="false">!</mo></mrow><mrow><mo stretchy="false">(</mo><mn>843</mn><mtext> </mtext><mn>446</mn><mtext> </mtext><mn>532</mn><mo>−</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">!</mo></mrow></mfrac><mrow><mn>843</mn><mtext> </mtext><mn>446</mn><mtext> </mtext><mn>53</mn><msup><mn>2</mn><mi>x</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\frac{843\:446\:532!}{(843\:446\:532-x)!}}{843\:446\:532^x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.476108em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.790108em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">843</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">446</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mord">53</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em"><span style="top:-2.9890000000000003em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">843</span><span class="mspace mtight" style="margin-right:0.26022222222222224em"></span><span class="mord mtight">446</span><span class="mspace mtight" style="margin-right:0.26022222222222224em"></span><span class="mord mtight">532</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)!</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">843</span><span class="mspace mtight" style="margin-right:0.26022222222222224em"></span><span class="mord mtight">446</span><span class="mspace mtight" style="margin-right:0.26022222222222224em"></span><span class="mord mtight">532</span><span class="mclose mtight">!</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><p>This is an extremely small number for any reasonable number of user accounts. Nevertheless, the code is there ... just in case.</p><p>Finally, the website rejects any operators already signed up or with too short a password.</p><h3>Logging in</h3><p>Login is another feature exclusive to bottle drive operators. The login screen simply sends a post request to the /api/auth/login endpoint and redirects to the page provided by the server. The page shows an error message if the email or password is invalid.</p><pre><code class="hljs language-js"><span class="hljs-title hljs-function">handleLoginSubmit</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-keyword">var</span> loginData = <span class="hljs-variable hljs-constant">JSON</span>.<span class="hljs-title hljs-function">stringify</span>({
        <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">email</span>,
        <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">password</span>
    })
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;/api/auth/login&quot;</span>, requestOptions)
        .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">replace</span>(response.<span class="hljs-property">url</span>)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
                <span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">setState</span>({ <span class="hljs-attr">email</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-attr">unauthorized</span>: <span class="hljs-literal">true</span> })
            }
        })
    <span class="hljs-comment">/* ... */</span>
}
</code></pre><p>The response URL replaces the current URL. This means the <code>/login</code> page is not kept in the browser history. After logging in, the bottle drive operator would have no need to log in again, so this behaviour is intentional. </p><p>Furthermore, the login page will redirect automatically to the <code>/list</code> page when logged in. Upon loading the <code>/login</code> page, the front end sends a request to the back end checking if the user is logged in. The server responds with a <code>true</code> or <code>false</code>. This uses the <code>session</code> module in the flask library. Each user receives a cookie upon signing in. Checking for a valid cookie occurs each time the user tries to access a restricted page. The same checking service redirects a logged-out user to the login page.</p><pre><code class="hljs language-js"><span class="hljs-comment">// Front end request code</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-title hljs-function">componentDidMount</span>(<span class="hljs-params"></span>) {
<span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;/api/auth/login&quot;</span>)
    .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title hljs-function">json</span>())
    .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result &amp;&amp; <span class="hljs-variable hljs-language">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title hljs-function">replace</span>(<span class="hljs-string">&quot;/list&quot;</span>))
    .<span class="hljs-title hljs-function">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable hljs-language">console</span>.<span class="hljs-title hljs-function">log</span>(error))
}
<span class="hljs-comment">// ...</span>
</code></pre><pre><code class="hljs language-python"><span class="hljs-comment"># Back end response code</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">LoginApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;userId&#x27;</span> <span class="hljs-keyword">in</span> session:
                <span class="hljs-keyword">return</span> jsonify(<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> jsonify(<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> InternalServerError
<span class="hljs-comment"># ...</span>
</code></pre><p>The server stores the email &amp; salted+hashed password, so authentication happens on the back end. The important part here is the <code>user.check_password()</code> method. This performs the exact same salt+hash operation used when creating the password. Login is successful when this result matches the stored salted+hashed password. This is because only the correct password will ever produce a result matching the stored password. If you are more interested in hashing (or you find this short explanation difficult to understand) check out this <a href="https://www.youtube.com/watch?v=yoMOAIzBSpY">video</a> and some of the other videos suggested towards the end.</p><pre><code class="hljs language-python"><span class="hljs-comment"># Post request</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">LoginApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):
 <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">try</span>:
        body = request.get_json()
        user = User.objects.get(email=body.get(<span class="hljs-string">&#x27;email&#x27;</span>))
        authorized = user.check_password(body.get(<span class="hljs-string">&#x27;password&#x27;</span>))
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> authorized:
            <span class="hljs-keyword">raise</span> UnauthorizedError
        session[<span class="hljs-string">&#x27;userId&#x27;</span>] = <span class="hljs-built_in">str</span>(user.<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&quot;/list&quot;</span>)
    <span class="hljs-keyword">except</span> (UnauthorizedError, DoesNotExist):
        <span class="hljs-keyword">raise</span> UnauthorizedError
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> InternalServerError
<span class="hljs-comment"># ...</span>
</code></pre><pre><code class="hljs language-python"><span class="hljs-comment"># Check password method in the User class</span>
<span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">check_password</span>(<span class="hljs-params">self, password</span>):
        <span class="hljs-keyword">return</span> check_password_hash(self.password, password)
</code></pre><h3>Adding new bottle drives</h3><p>Adding bottle drives happens on the <code>/list</code> page.</p><p><a href="/assets/img/bottles-against-covid/list-page.png"><img src="/assets/img/bottles-against-covid/list-page.png" alt="list page"/></a></p><p>To add a bottle drive, the operator simply selects a date, types in a maximum number of boxes, and presses the ➕ button. Filling out these fields automatically updates the <code>state</code> object. Pressing the button sends a post request to the back end with the necessary information. Upon successfully sending the data, the page reloads the table of drives. This makes the new drive visible to the operator.</p><pre><code class="hljs language-js"><span class="hljs-title hljs-function">sendNewDrive</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-keyword">const</span> driveData = <span class="hljs-variable hljs-constant">JSON</span>.<span class="hljs-title hljs-function">stringify</span>({
        <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">newDrive</span>.<span class="hljs-property">date</span>,
        <span class="hljs-string">&quot;crates_limit&quot;</span>: <span class="hljs-variable hljs-language">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">newDrive</span>.<span class="hljs-property">crates_limit</span>
    })
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-title hljs-function">fetch</span>(<span class="hljs-string">&quot;/api/list&quot;</span>, requestOptions)
        .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title hljs-function">json</span>())
        .<span class="hljs-title hljs-function">then</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">loadDrives</span>()
            <span class="hljs-variable hljs-language">this</span>.<span class="hljs-title hljs-function">setState</span>({ <span class="hljs-attr">newDrive</span>: { <span class="hljs-string">&quot;date&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;crates_limit&quot;</span>: <span class="hljs-string">&quot;&quot;</span> } })
        })
        <span class="hljs-comment">/* ... */</span>
}
</code></pre><p>The back end only creates drives that start tomorrow at the earliest. It rejects any request on a past date or the current date. Also, of note is the addition of the drive object id to the user object. This makes the list of the operator&#x27;s drives accessible by both searching the <code>link_code</code> and inspecting the specific user object. Inspecting the object takes less time than searching through the entire database of drives. Both paths produce the exact same object; one is not simply a copy of the other. This is also part of a security component where another user cannot delete someone else&#x27;s drive. Only the creator of a drive can delete it. </p><pre><code class="hljs language-python"><span class="hljs-comment"># Back end to create a new bottle drive object</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">ListDriveApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):<span class="hljs-comment">#to modify a bottle drive instance</span>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">post</span>(<span class="hljs-params">self</span>): <span class="hljs-comment"># make a new drive instance</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;userId&#x27;</span> <span class="hljs-keyword">in</span> session:
            <span class="hljs-keyword">try</span>:
                user_id = session[<span class="hljs-string">&#x27;userId&#x27;</span>]
                body = request.get_json()
                <span class="hljs-keyword">if</span> datetime.strptime(body[<span class="hljs-string">&quot;date&quot;</span>], <span class="hljs-string">&quot;%Y-%m-%d&quot;</span>) &lt; datetime.now():
                    <span class="hljs-keyword">raise</span> ValidationError
                user = User.objects.get(<span class="hljs-built_in">id</span>=user_id)
                pickupInfo =  PickupInfo(**body, created_by=user, active=<span class="hljs-literal">True</span>, link_code=user.link_code )
                pickupInfo.save()
                user.update(push__drives=pickupInfo)
                user.save()
                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-number">200</span>
            <span class="hljs-comment"># ...</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-comment"># ...</span>
        <span class="hljs-keyword">else</span>:
            abort(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;unauthorized&quot;</span>)
    <span class="hljs-comment"># ...</span>
</code></pre><p>The other part of the deletion restriction is registering a delete rule in the MongoDB model declarations.</p><pre><code class="hljs language-python"><span class="hljs-comment"># ...</span>
User.register_delete_rule(PickupInfo, <span class="hljs-string">&#x27;created_by&#x27;</span>, db.CASCADE)
<span class="hljs-comment"># ...</span>
</code></pre><h3>Making pickup day easy</h3><p>Pickup day is extremely easy because the bottle drive operator can download the address and other pickup info of each person registered for a specific bottle drive. All the operator needs to do is click the ⬇️ (download) button next to their bottle drive of choice. This saves a .csv file with each registrant&#x27;s name, email, address, neighbourhood, number of boxes to pick up, and note. The addition of the neighbourhood field was a suggestion by St. Joe&#x27;s community campaign officer Kathy Richmond. Listing the neighbourhood makes it easier for operators to know which houses are close to each other and plan the order of pickups accordingly.</p><p>Interestingly, the server never stores the .csv file. It instead streams the file to the user. This cuts down on disk use. Streaming works through use of the <code>yield</code> keyword. This allows a function/method (in this case <code>generate()</code>) to return multiple values before halting. Each of these values are then sent to the end user.</p><pre><code class="hljs language-python"><span class="hljs-keyword">import</span> csv
<span class="hljs-comment"># ...</span>
<span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">DownloadAddressesApi</span>(<span class="hljs-title hljs-class hljs-inherited">Resource</span>):

    <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">get</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;userId&#x27;</span> <span class="hljs-keyword">in</span> session:
            <span class="hljs-keyword">try</span>:
                user_id = session[<span class="hljs-string">&#x27;userId&#x27;</span>]
                date = request.args.get(<span class="hljs-string">&#x27;date&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)
                pickupInfo = PickupInfo.objects.get(created_by=user_id, date=date)

                <span class="hljs-keyword">def</span> <span class="hljs-title hljs-function">generate</span>(<span class="hljs-params">pickupInfo</span>):
                    data = StringIO()
                    w = csv.writer(data)

                    <span class="hljs-comment"># write header</span>
                    w.writerow((<span class="hljs-string">&quot;Name&quot;</span>, <span class="hljs-string">&quot;Address&quot;</span>, <span class="hljs-string">&quot;Neighbourhood&quot;</span>, <span class="hljs-string">&quot;e-mail&quot;</span>, <span class="hljs-string">&quot;boxes&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>))
                    <span class="hljs-keyword">yield</span> data.getvalue()
                    data.seek(<span class="hljs-number">0</span>)
                    data.truncate(<span class="hljs-number">0</span>)

                    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> pickupInfo.addresses:
                        w.writerow((
                            item.name,
                            item.homeAddress,
                            item.neighbourhood,
                            item.email,
                            item.crates,
                            item.message
                        ))
                        <span class="hljs-keyword">yield</span> data.getvalue()
                        data.seek(<span class="hljs-number">0</span>)
                        data.truncate(<span class="hljs-number">0</span>)

                <span class="hljs-comment"># stream the response as the data is generated</span>
                response = Response(generate(pickupInfo), mimetype=<span class="hljs-string">&#x27;text/csv&#x27;</span>)
                <span class="hljs-comment"># add a filename</span>
                response.headers.<span class="hljs-built_in">set</span>(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment&quot;</span>, filename=<span class="hljs-string">f&quot;<span class="hljs-subst">{pickupInfo.date.strftime(<span class="hljs-string">&#x27;%Y-%m-%d&#x27;</span>)}</span>-pickup-addresses.csv&quot;</span>)
                <span class="hljs-keyword">return</span> response
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-keyword">raise</span> InternalServerError
        <span class="hljs-keyword">else</span>:
            abort(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;unauthorized&quot;</span>)
</code></pre><h2>Reflecting on the build process</h2><h3>React Front end</h3><p>My experience with React Native at my job last summer and DeltaHacks IV was invaluable for this part. However, I did learn a lot of new things about React and JS from this project. </p><p>I think my biggest growth was in design. This is the first website I have made where the visual aspects were considered. All my prior layout experience was with React Native, which is a little bit different from ReactJS. I also feel like I garnered a better understanding of React and JS this time compared to last. </p><p>If I were to do this again, I might use something like <a href="https://github.com/preactjs/preact">Preact</a>. I feel as if I have left much of the capabilities of React on the table, and that it may have been overkill.</p><p>Also, next time I would use hooks. I have started using hooks on another project and they are <strong><em>significantly</em></strong> easier to use than classes. I am not sure why I was so afraid to use them.</p><h3>Flask Back End</h3><p>This part of the build process was almost entirely foreign to me. I had some experience with basic Flask development after my DeltaHacks IV project, but otherwise I was in the dark. I was able to build the foundations for my website thanks to the great tutorials available online, specifically <a href="https://blog.miguelgrinberg.com/post/how-to-deploy-a-react--flask-project">this one</a>, and <a href="https://dev.to/paurakhsharma/flask-rest-api-part-1-using-mongodb-with-flask-3g7d">this one</a>.</p><p>If I were to do this part again, I would likely choose a different framework than Flask. I have started another project (it is a secret right now) using <a href="https://fastapi.tiangolo.com/">FastAPI</a>. I find it <em>much</em> nicer to use than Flask.</p><h3>MongoDB Database</h3><p>I will say, using MongoDB with mongoengine was a joy. It was very easy to use and the built-in geo-query capabilities of MongoDB made the search feature on the website&#x27;s main page a snap.</p><h3>Writing this blog post</h3><p>I have not done a blog post like this in a long time. It took an immense amount of time and is likely too long for anyone to read to completion ... but I did catch a lot of fringe mistakes while writing it. Nothing program breaking (as these are easier to notice while writing code), but I found a lot of code that was not needed anymore and made things more complex. It has also helped me reflect on what I learned from this project and where I can improve.</p></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Bottles Against COVID-19","name":"2020-08-30-Bottles-Against-COVID","content":{"compiledSource":"var i=Object.defineProperty,h=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable;var m=(e,s,n)=\u003es in e?i(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n,a=(e,s)=\u003e{for(var n in s||(s={}))r.call(s,n)\u0026\u0026m(e,n,s[n]);if(p)for(var n of p(s))l.call(s,n)\u0026\u0026m(e,n,s[n]);return e},o=(e,s)=\u003eh(e,N(s));var c=(e,s)=\u003e{var n={};for(var t in e)r.call(e,t)\u0026\u0026s.indexOf(t)\u003c0\u0026\u0026(n[t]=e[t]);if(e!=null\u0026\u0026p)for(var t of p(e))s.indexOf(t)\u003c0\u0026\u0026l.call(e,t)\u0026\u0026(n[t]=e[t]);return n};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(n){var t=n,{components:e}=t,s=c(t,[\"components\"]);return mdx(MDXLayout,o(a(a({},layoutProps),s),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Lacking a summer job thanks to the COVID-19 pandemic, my sister and I wanted to make the most of this situation by helping those around us. So, we created \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://bottlesagainstcovid.org\"}),\"BottlesAgainstCOVID.org\"),\". This not only made it easy for us to collect empty bottles from our neighbours, but easy for anyone else to sign up and do the same. The intent is for all proceeds to be donated to charity. In our case, we raised over $3k for St. Joe's Hospital in Toronto.\"),mdx(\"h2\",null,\"How it all started\"),mdx(\"p\",null,\"During the COVID-19 pandemic people have been spending a lot more time at home. With this, alcohol consumption has increased greatly. In the USA, \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://apnews.com/c407ecb931c6c528b4cceb0ecc216f0c\"}),\"some studies suggest\"),\" a 55% year-over-year increase in alcohol sales from this time last year. \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.ccsa.ca/sites/default/files/2020-04/CCSA-NANOS-Alcohol-Consumption-During-COVID-19-Report-2020-en.pdf\"}),\"Surveys show\"),' that Canada is no different. While this \"coping mechanism\" is ',mdx(\"a\",a({parentName:\"p\"},{href:\"http://www.euro.who.int/__data/assets/pdf_file/0010/437608/Alcohol-and-COVID-19-what-you-need-to-know.pdf\"}),\"ill-advised by the WHO\"),\", it seems that people do not seem to care all that much.\"),mdx(\"p\",null,\"It was my sister's idea to turn this into something positive. She figured that all the empty bottles sitting at people's homes could be returned to the Beer Store, and the proceeds could be donated to charity. Her charity of choice was the \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://secure3.convio.net/stjoca/site/SPageNavigator/westendheroes_home.html\"}),\"St. Joe's Hospital COVID-19 fund\"),\". She created a \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://calendly.com/\"}),\"calendly\"),\" page and posted on a few local Facebook pages. Pickup would be completely contactless \\u2013 registrants would simply leave their empties on their front porch or curb. News of the initiative spread fast, and hundreds of people signed up.\"),mdx(\"p\",null,\"On the first pickup day we realized there was a problem. We had \",mdx(\"em\",{parentName:\"p\"},\"a lot\"),\" more support than expected. So much so it was overwhelming. Bottle pickup, which was estimated to take 3 hours, took 8. In one day, we collected more than 4000 bottles from over 50 houses. While it was great to see the community rally behind our cause, this amount was overwhelming. It took 6 full days of bottle sorting and returning to get through this amount. The day after we finished was another scheduled pickup day. We needed a way to limit our intake without limiting our impact.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/day-1-bottle-drive-cropped.jpg\",alt:\"Day one of bottle collections\"}))),mdx(\"p\",null,\"So, I started working on a website. The goal was to create something that could limit the amount of collections by number of bottles (instead of number of pickups) and allow others to join in on our solution. By allowing anyone to create their own bottle drive, we reduce the overall number of people leaving their homes to return empties and empower others to help.\"),mdx(\"h2\",null,\"How the website works\"),mdx(\"p\",null,\"The front end is client rendered and communicates directly with the Flask back end using the \",mdx(\"inlineCode\",{parentName:\"p\"},\"fetch\"),\" API. Some pages (home page, FAQ page) are hand-written in HTML with a little bit of JS. Yarn handles package management for the front end.\"),mdx(\"p\",null,'The Flask back end is mostly RESTful, with one caveat: the server handles session management using the \"session\" library built into Flask. The back end communicates with the database via the mongoengine library. Poetry handles back end package management.'),mdx(\"p\",null,\"The database in use is MongoDB. Before this project, I had no experience with MongoDB. Everything I know, I learned from building this website. The decision to chose MongoDB came as a recommendation from a friend to give NoSQL a try.\"),mdx(\"h3\",null,\"Searching for existing bottle drives\"),mdx(\"p\",null,\"Searching for drives is likely the most used feature of the website. As such, it is important the search feature be accurate and intuitive. Therefore, the search function is on the main web page, and a user can use either geolocation or a postal code to query for drives in their area.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/home-page.png\",alt:\"home page\"}))),mdx(\"p\",null,'Clicking the \"Search by location\" button calls the ',mdx(\"inlineCode\",{parentName:\"p\"},\"locationSearch()\"),\" function. This first checks for the presence of the HTML geolocation API, preventing null errors if the feature is unsupported.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"locationSearch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (navigator.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),`) {\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*important parts of function go here*/\"),`\n    }\n}\n`)),mdx(\"p\",null,\"Next, it calls this API, triggering a prompt for the user to allow access to their location. \"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),\"navigator.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getCurrentPosition\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*callback function*/\"),`)\n`)),mdx(\"p\",null,\"The callback function here formats the \",mdx(\"inlineCode\",{parentName:\"p\"},\"longitude\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"latitude\"),\" results into a URL query string and redirects the user to the search results page.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),\"navigator.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getCurrentPosition\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),` {\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" queryString = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`lat=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${result.coords.latitude}\"),\"\u0026long=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${result.coords.longitude}\"),\"\u0026postal=false`\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"assign\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`/search?\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${queryString}\"),\"`\"),`)\n})\n`)),mdx(\"p\",null,'The \"Search by location\" button becomes disabled if at any point the function fails to return an appropriate geolocation. Often this occurs when the user chooses to block the website from accessing their precise location. Disabling the button prevents future ineffective search attempts and makes it clear that the user should instead search via postal code.'),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),\"navigator.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getCurrentPosition\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),` {\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*query string and redirect part from above*/\"),`\n}, `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"error\"),\" =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"locSearch\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`)\n\n`)),mdx(\"p\",null,\"Putting this all together (and compacting some of the code), results in the function's final form:\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"locationSearch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (navigator.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),`) {\n        navigator.`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geolocation\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getCurrentPosition\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"assign\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`/search?lat=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${result.coords.latitude}\"),\"\u0026long=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${result.coords.longitude}\"),\"\u0026postal=false`\"),\"), \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),\"(\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"error\"),\") =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"locSearch\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`)\n    }\n}\n`)),mdx(\"p\",null,\"Postal code searches are first vetted through an input regex statement. This restricts the valid input to that of any 6-digit Canadian postal code with or without a separating space. This statement (taken from \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://stackoverflow.com/questions/15774555/efficient-regex-for-canadian-postal-code-function/46761018\"}),\"here\"),\") is quite strict and goes beyond just number/letter alternating pattern. Most interestingly, it follows the Canada Post regulations of not containing letters which can be confused for numbers (I, O, Q, Z, ...). \"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-html\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"input\"),` \n  `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"id\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"postalCode\"'),` \n  `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"placeholder\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"K1A 0A9\"'),` \n  `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"pattern\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"^([ABCEGHJ-NPRSTVXY]|[abceghj-nprstvxy])[0-9]([ABCEGHJ-NPRSTV-Z]|[abceghj-nprstv-z]) ?[0-9]([ABCEGHJ-NPRSTV-Z]|[abceghj-nprstv-z])[0-9]$\"'),`\n\u003e`),`\n`)),mdx(\"p\",null,\"After pressing the search button, the \",mdx(\"inlineCode\",{parentName:\"p\"},\"postalSearch()\"),\" function validates the input and queries a public database for postal code information. Also, disabling the search button and changing the cursor prevents repeated queries to the database while waiting for a response. The \",mdx(\"inlineCode\",{parentName:\"p\"},\"value.replace(' ', '')\"),\" line removes the (optional) space between the two parts of a postal code.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"postalSearch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" postalCode = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalCode\"'),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"checkValidity\"),\"() \u0026\u0026 postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"value\"),\" !== \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"style\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"cursor\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"wait\"'),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://geocoder.ca/?json=1\u0026getpolygon=1\u0026postal=\"'),\" + postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"value\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"replace\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"' '\"),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"''\"),`))\n            .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),\" result.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`())\n    }\n}\n`)),mdx(\"p\",null,\"The geocoder API returns a polygon representing the area covered by the postal code. The function takes this polygon and generates a URL query string. The query includes a Boolean signifying that the search used a postal code. Finally, the function redirects the user to their requested search results.\"),mdx(\"p\",null,\"The final function looks like this:\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"postalSearch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" postalCode = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalCode\"'),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"checkValidity\"),\"() \u0026\u0026 postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"value\"),\" !== \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"style\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"cursor\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"wait\"'),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://geocoder.ca/?json=1\u0026getpolygon=1\u0026postal=\"'),\" + postalCode.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"value\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"replace\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"' '\"),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"''\"),`))\n            .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),\" result.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`())\n            .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"value\"),\" =\u003e\"),` {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"false\"),`\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"document\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"getElementById\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postalButton\"'),\").\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"style\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"cursor\"),\" = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"auto\"'),`\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"assign\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`/search?poly=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${value.boundary}\"),\"\u0026postal=true`\"),`)\n            })\n    }\n}\n`)),mdx(\"p\",null,\"Upon loading the \",mdx(\"inlineCode\",{parentName:\"p\"},\"LocationSearch\"),\" page, the React component fetches database results by passing the query to the underlying API. State then updates to store the response.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"default\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"LocationSearch\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"extends\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"React.Component\"),` {\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"componentDidMount\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`/api/search\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".props.location.search}\"),\"`\"),`)\n          .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),\" result.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`())\n          .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"response\"),\" =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"setState\"),\"({ \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"response\"),`: response }))\n          .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"catch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"error\"),\" =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"console\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"log\"),`(error))\n  }\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n}\n`)),mdx(\"p\",null,\"Under the hood, the API parses the query string. The code converts the postal code polygon coordinates into a GeoJSON polygon when required. Of note here is that GeoJSON requires coordinates to be in \",mdx(\"inlineCode\",{parentName:\"p\"},\"[long, lat]\"),\" format instead of the provided \",mdx(\"inlineCode\",{parentName:\"p\"},\"[lat, long]\"),\". Next, the built-in geo search capabilities of MongoDB become useful. The program queries the MongoDB database for existing bottle drive polygons which intersect with the searcher's GPS location or postal code area. Bottle drive operators define their pickup polygon when they create an account. The web page will show multiple listings if multiple drives are in the searcher's area.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/search-page.png\",alt:\"search results\"}))),mdx(\"p\",null,\"Also, for drives to show up in the search results, the bottle drive operator must have initialized a drive. Bottle drives with no drives will not show up. However, bottle drives with no \",mdx(\"em\",{parentName:\"p\"},\"active\"),\" drives \",mdx(\"em\",{parentName:\"p\"},\"will\"),\" appear. This means a bottle drive operator is working in the area, but nothing is available just yet. Drive deactivation occurs automatically when at capacity or if the date of said drive has passed. Perhaps there will be new drives in the future, so the searcher can view the page to bookmark/share accordingly.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"SearchForDrivesApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            loc = `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"None\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" request.args.get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"postal\"'),\") == \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"true\"'),`:\n                polyResult = request.args.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"poly\"'),\").split(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\",\"'),`)\n                loc = {\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\":\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Polygon\"'),`,\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"coordinates\"'),`: [[]],\n                }\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" i \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"range\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\",\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"len\"),\"(polyResult)-\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"1\"),\",\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"2\"),`):\n                    loc[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"coordinates\"'),\"][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"].append([\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"float\"),\"(polyResult[i+\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"1\"),\"]),\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"float\"),`(polyResult[i])])\n                loc[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"coordinates\"'),\"][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"].append(loc[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"coordinates\"'),\"][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"]) \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# GeoJSON polygons must end with their starting coordinate\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),`:\n                loc = [`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"float\"),\"(request.args.get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"long\"'),\")) , \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"float\"),\"(request.args.get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"lat\"'),`))]\n            drives = User.objects(geo_region__geo_intersects=loc, drives__not__size=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`)\n            driveList = []\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" i \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),\" drives \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"or\"),\" [\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"None\"),`]:\n                driveList.append({\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"name\"'),\":i[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"name\"'),`],\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"link_code\"'),\":i[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"link_code\"'),`],\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"header\"'),\":i[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"header\"'),`],\n                })\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),`(jsonify(driveList))\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),\" Exception \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"as\"),` e:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InternalServerError\n`)),mdx(\"h3\",null,\"Handling bottle drive sign-ups\"),mdx(\"p\",null,\"The website redirects the searcher to the individual drive page upon clicking through on the search result card. \"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/pickup-initial-page.jpg\",alt:\"drive page\"}))),mdx(\"p\",null,\"Here the user will see the drive pickup area, the time of day bottle pickup occurs, and the charity specified by the bottle drive operator. With the address search feature, they can begin the process of signing up for a bottle pickup.\"),mdx(\"p\",null,\"All this data comes from a get request with the 5-character link code matching that of the current web page (ex. \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://bottlesagainstcovid.org/XXf3d\"}),\"bottlesagainstcovid.org/XXf3d\"),\" has a link code of \",mdx(\"inlineCode\",{parentName:\"p\"},\"XXf3d\"),\").\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"componentDidMount\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/api/\"'),\" + \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"link_code\"),`)\n        .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"response\"),\" =\u003e\"),` {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"status\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"200\"),`) {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`()\n            } `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"status\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"404\"),`) {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"replace\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/404\"'),`)\n            }\n        })\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n}\n`)),mdx(\"p\",null,\"On the server side, Flask uses the 5-character \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\" in conjunction with the current date to query the MongoDB database for drives the operator is running.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            pickupInfo = PickupInfo.objects(link_code__exact=link_code, date__gte=datetime.now()).order_by(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'date'\"),`)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"Each drive object has a \",mdx(\"inlineCode\",{parentName:\"p\"},\"created_by\"),\" field which links to a \",mdx(\"inlineCode\",{parentName:\"p\"},\"user\"),\" object. The \",mdx(\"inlineCode\",{parentName:\"p\"},\"user\"),\" object stores info on the bottle drive operator. The response requires the operator's name, their pickup region polygon, their preferred pickup times (morning/afternoon/evening), and their header message, which will display the charity they intend to donate funds to.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n        userInfo = User.objects.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),\"=pickupInfo[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"].created_by.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`)\n        pickupObj = {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"drive_name\"'),`:userInfo.name,\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"pickup_times\"'),`: userInfo.pickup_times,\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"dates_and_crates_left\"'),`: [],\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"geo_region\"'),`: userInfo.geo_region,\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"header\"'),`:userInfo.header\n        }\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"Next, the code iterates through all the \",mdx(\"em\",{parentName:\"p\"},\"active\"),\" drives returned as \",mdx(\"inlineCode\",{parentName:\"p\"},\"pickupInfo\"),\". This loop appends a tuple with the date of each active drive and the capacity of bottles they have remaining at the time of the query (limit - current amount) to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"dates_and_crates_left\"),\" key of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"pickupObj\"),\". The final step is returning \",mdx(\"inlineCode\",{parentName:\"p\"},\"pickupObj\"),\".\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            pickupInfo = PickupInfo.objects(link_code__exact=link_code, date__gte=datetime.now()).order_by(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'date'\"),`)\n            userInfo = User.objects.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),\"=pickupInfo[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"].created_by.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`)\n            pickupObj = {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"drive_name\"'),`:userInfo.name,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"pickup_times\"'),`: userInfo.pickup_times,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"dates_and_crates_left\"'),`: [],\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"geo_region\"'),`: userInfo.geo_region,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"header\"'),`:userInfo.header\n            }\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" i \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),\" pickupInfo \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"or\"),\" [\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"None\"),`]:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" i.active == \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`:\n                    pickupObj[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"dates_and_crates_left\"'),\"].append((i[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\"].strftime(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"%Y-%m-%d\"'),\"), i.crates_limit-i[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"crates\"'),`]))\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` jsonify(pickupObj)\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"Before signing up, the user sees the pickup region as an SVG drawn onto the map. This feature uses the \",mdx(\"inlineCode\",{parentName:\"p\"},\"latLngToPixel()\"),\" function provided as a part of the \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://pigeon-maps.js.org/\"}),\"pigeon-maps\"),\" library. Using a dynamic map with an SVG instead of a static image is advantageous because it allows user interaction (panning \u0026 zooming).\"),mdx(\"p\",null,\"This function maps each geo-coordinate in the geoJSON polygon to a corresponding pixel on the map.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"Polygon\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"{ mapState: { width, height }, latLngToPixel, coordsArray, colour }\"),`) {\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),\" coords = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" (\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),\" i = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"; i \u003c coordsArray.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"length\"),`; i++) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),\" latLngPixels = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"latLngToPixel\"),\"([coordsArray[i][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"1\"),\"], coordsArray[i][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`]])\n        coords += `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${latLngPixels[\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-number\"}),\"0\"),\"]}\"),\",\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${latLngPixels[\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-number\"}),\"1\"),\"]}\"),\" `\"),`\n    }\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` (\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"xml\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"svg\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"width\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{width}\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"height\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{height}\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"style\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{{\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"fill:\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"colour\"),\", \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"opacity:\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"0.4\"),\", \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"top:\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"0\"),\", \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"left:\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"0\"),\" }}\u003e\"),`\n            `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"polygon\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"points\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{coords}\"),\" /\u003e\"),`\n        `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c/\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"svg\"),\"\u003e\")),`\n    )\n}\n`)),mdx(\"p\",null,\"A library called \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://github.com/mapbox/polylabel\"}),\"polylabel\"),' determines the center point of this map. This library aims to find the \"visual\" centre of the polygon and avoids issues caused by irregular shapes. Usage is as simple as passing the entire geoJSON coordinate array as a parameter. The result is a 2-element array.'),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),\" center = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"polylabel\"),\"(result.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"geo_region\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"coordinates\"),`)\n`)),mdx(\"p\",null,\"To sign up for a bottle drive, the user first searches for their address. \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.npmjs.com/package/nominatim-browser\"}),\"Nominatim\"),\" matches this query with the Open Street Map (OSM) address database.\"),mdx(\"p\",null,'This \"search address first\" method allows for verification that the address is eligible for pickup. The ',mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.npmjs.com/package/robust-point-in-polygon\"}),\"robust-point-in-polygon\"),\" library means we can check that the geo-coordinates of the searched address fall inside the pickup region. This method also ensures no errors in street name spellings that could make pickup difficult.\"),mdx(\"p\",null,\"The website blocks users from completing further sign-up steps if they are not within the specified region.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/failed-address.png\",alt:\"failed search\"}))),mdx(\"p\",null,\"The searched address also appears on the pickup region map so the user can visually see if the address is correct and whether they fall inside the pickup region. The first few form fields also appear.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/address-and-name.jpg\",alt:\"post sign up search\"}))),mdx(\"p\",null,\"After selecting a date, the rest of the form fields appear. \"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/rest-of-fields.png\",alt:\"rest of form fields\"}))),mdx(\"p\",null,\"Here the user can note how many boxes of bottles they would like to donate. Individually, these fields must be greater than or equal to zero. Together, their sum must be less than the limit. The front end only sends the sum back to the server. Separating the fields encourages users to follow the restrictions for pickups (ex. no cans). \"),mdx(\"p\",null,\"Using \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.hcaptcha.com/\"}),\"hCaptcha\"),\" blocks any possibility of bots filling out the form. It also provides the opportunity to pay back Wikimedia who works with OSM to provide map services for free. All funds generated from using hCaptcha are automatically donated to Wikimedia. Successful completion of the hCaptcha field stores a token in \",mdx(\"inlineCode\",{parentName:\"p\"},\"state\"),\".\"),mdx(\"p\",null,\"The \",mdx(\"inlineCode\",{parentName:\"p\"},\"state\"),\" object stores each field of the form as it is being filled out. Submitting the form calls the \",mdx(\"inlineCode\",{parentName:\"p\"},\"onSubmit()\"),\" method. \"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"onSubmit\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"event\"),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"disabled\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n    } `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"validateInput\"),\"() === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),\" myHeaders = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"Headers\"),`();\n        myHeaders.`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"append\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Content-Type\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"application/json\"'),`);\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),` signupData = {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"details\"'),`: {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"name\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"name\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"homeAddress\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"address\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"neighbourhood\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"neighbourhood\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"email\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"email\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"crates\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"parseInt\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"twelvePack\"),\") + \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"parseInt\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"sixPack\"),\") + \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"parseInt\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"beerBottles\"),`),\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"message\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"message\"),`,\n            },\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"dates_and_crates_left\"),\"[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"selectedDate\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"split\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"','\"),\")[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"1\"),\"]][\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`],\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"token\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"hCaptcha_token\"),`\n        }\n        \n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),` requestOptions = {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"method\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'POST'\"),`,\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"headers\"),`: myHeaders,\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"body\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-constant\"}),\"JSON\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"stringify\"),`(signupData),\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"redirect\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'follow'\"),`,\n        };\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"`/api/\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"${\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".state.link_code}\"),\"`\"),`, requestOptions)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n    }\n}\n`)),mdx(\"p\",null,\"Assuming valid input, the code first constructs the \",mdx(\"inlineCode\",{parentName:\"p\"},\"signupData\"),\" object. This object uses info stored in \",mdx(\"inlineCode\",{parentName:\"p\"},\"state\"),\". Next, the program sends a \",mdx(\"inlineCode\",{parentName:\"p\"},\"post\"),\" request to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/api/{link_code}\"),\" endpoint. This is the same URL which the drive info was fetched from in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"componentDidMount()\"),\" method.\"),mdx(\"p\",null,\"Server-side, the first operation is parsing the json into a python dictionary.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"SignupApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ... get request code shown earlier ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            body = request.get_json()\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"Authentication of the hCaptcha token must happen server-side for proper protection against bots. Client-side captcha authentication can be overridden, defeating its sole purpose. Here the back end redirects the token sent by the client to hCaptcha's servers. The \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://requests.readthedocs.io/en/master/\"}),\"requests\"),\" library handles this. The request returns \",mdx(\"inlineCode\",{parentName:\"p\"},\"{ success: True }\"),\" for valid tokens and \",mdx(\"inlineCode\",{parentName:\"p\"},\"{ success: False }\"),\" for everything else (expired or invalid). In the case of an invalid token, the server throws an \",mdx(\"inlineCode\",{parentName:\"p\"},\"InvalidTokenError\"),\", breaking the \",mdx(\"inlineCode\",{parentName:\"p\"},\"try-except\"),\" block.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"SignupApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n            token = body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"token\"'),`)\n            data = { `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'secret'\"),\": current_app.config[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"HCAPTCHA_SECRET_KEY\"'),\"], \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'response'\"),`: token }\n            response = requests.post(url=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://hcaptcha.com/siteverify\"'),`, data=data)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" response.json()[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"success\"'),\"] == \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"False\"),` :\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InvalidTokenError\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` InvalidTokenError:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InvalidTokenError\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"The next step is querying the MongoDB database to access the object representing the requested bottle drive. This means the \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"date\"),\" match that sent in the post request.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"SignupApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n            pickupInfo = PickupInfo.objects.get(link_code__exact=link_code, date__exact=body[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\"], active=\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"#must query to determine uniqueness as it is required on a per-date basis\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" pickupInfo.addresses.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"filter\"),\"(homeAddress=body.get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"details\"'),\").get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"homeAddress\"'),\")).count() \u003e \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` NotUniqueError\n            pickupAddresses = PickupAddresses(**body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"details\"'),`))\n            pickupInfo.update(push__addresses=pickupAddresses, inc__crates=body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"details\"'),\").get(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"crates\"'),`))\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"On line 8 the code checks to make sure the user has not already registered for a pickup on this date. This prevents someone from accidentally filling up the capacity of a certain date when they only intended to edit their previous sign up info. Unfortunately, an edit system is not implemented. The user can save their extra bottles and sign up for the next pickup date. Most, however, just put their extra boxes out anyway. We still picked them up.\"),mdx(\"p\",null,\"After passing all these validation checks, the \",mdx(\"inlineCode\",{parentName:\"p\"},\"details\"),\" key of \",mdx(\"inlineCode\",{parentName:\"p\"},\"body\"),\" unwraps into a \",mdx(\"inlineCode\",{parentName:\"p\"},\"PickupAddresses\"),\" object. The program stores this object in the database. Using \",mdx(\"inlineCode\",{parentName:\"p\"},\"push__addresses\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"inc__crates\"),\" avoids a race condition. A race condition (or race hazard) is the name for when a computer tries to do two things at the same time. For example, if two users try to sign up for the same bottle drive at the same time. With some exceptions, computers can only work on one thing at a time. Without proper handling, the computer may store the first address in the database and then immediately overwrite it with the second address. This would mean a loss of data. The first user, despite signing up properly, will not have their information recorded and thus will not have their bottles picked up. Pushing and incrementing prevents this by simply telling the computer to add information to the database instead of specifying \",mdx(\"em\",{parentName:\"p\"},\"where\"),\" in the database to add information.\"),mdx(\"p\",null,\"Finally, the program compares the number of signed up crates to the designated limit. Reaching the limit automatically switches the drive's \",mdx(\"inlineCode\",{parentName:\"p\"},\"active\"),\" field to \",mdx(\"inlineCode\",{parentName:\"p\"},\"False\"),\" preventing further sign ups.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"SignupApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, link_code\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"#check if the max number of crates has been reached\"),`\n            pickupInfo = PickupInfo.objects(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),\"=pickupInfo.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`).no_cache()\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\"(pickupInfo[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),\"].crates\u003e=pickupInfo[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`].crates_limit):\n                pickupInfo.update(active=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"False\"),`)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`\n`)),mdx(\"h3\",null,\"Handling new bottle drive operators\"),mdx(\"p\",null,\"A key feature of \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://bottlesagainstcovid.org\"}),\"BottlesAgainstCOVID.org\"),' is the ability for others to easily create their own bottle drives. While it would be much easier to program just the \"regular\" sign up, opening the service up to others allows more communities to get involved in the fight against COVID-19.'),mdx(\"p\",null,\"New bottle drive operators sign up at \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://bottlesagainstcovid.org/signup\"}),\"bottlesagainstcovid.org/signup\"),\". Here operators complete the usual fields (name, email, password) as well as draw a pickup region on the map. \"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/operator-fields-empty.jpg\",alt:\"pickup sign up page\"}))),mdx(\"p\",null,\"The text fields work similarly to those on the regular sign up page; the \",mdx(\"inlineCode\",{parentName:\"p\"},\"state\"),\" object stores field data and updates with each edit using the \",mdx(\"inlineCode\",{parentName:\"p\"},\"handleInputChange()\"),\" method. A special case here is when the input is a checkbox instead of a text field.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"default\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"Register\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"extends\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"React.Component\"),` {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"handleInputChange\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"event\"),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" target = event.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"target\"),`;\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"let\"),` value;\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (target.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"type\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'checkbox'\"),`) {\n            value = target.`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"checked\"),`;\n        } `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),` {\n            value = target.`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"value\"),`;\n        }\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" name = target.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"name\"),`;\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"setState\"),`({\n            [name]: value\n        });\n    }\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"render\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`){\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` (\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"xml\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"input\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"className\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"pickup-signup-input\"'),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"name\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"name\"'),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"type\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"text\"'),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"placeholder\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),'\"Your name\"'),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"value\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{this.state.name}\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"onChange\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{this.handleInputChange}\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"required\"),\" /\u003e\")),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n        )\n    }\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n}\n`)),mdx(\"p\",null,\"The most complex feature on this page is the pickup region drawing apparatus. Here it is in action:\"),mdx(\"video\",{controls:!0,muted:!0,allowFullScreen:!0,loop:!0},mdx(\"source\",{src:\"/assets/img/bottles-against-covid/draw-region.mp4\",type:\"video/mp4\"})),mdx(\"p\",null,\"The \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://urbica.github.io/react-map-gl-draw/\"}),\"@urbica/react-map-gl-draw\"),\" library does nearly all the heavy lifting here. Everything works so long as configuration of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003cMapGL\u003e\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003cDraw\u003e\"),` components match the examples on the library's website. Notably the \"draw region\" control is external. This is because, despite being able to draw multiple polygons, the library only returns the state of the most recently drawn one. To solve this issue, the sign-up page restricts an operator's ability to draw multiple polygons.`),mdx(\"p\",null,\"The most significant difficulty with this library was the implementation of 3rd party map tiling services. MapBox builds \",mdx(\"inlineCode\",{parentName:\"p\"},\"\u003cMapGL\u003e\"),\" and closely links it to their services. Their free tier requires an API key and thus an account to use. OSM is a truly free alternative. The \",mdx(\"inlineCode\",{parentName:\"p\"},\"mapStyle\"),\" object was the most challenging part to figure out as examples are essentially non-existent. This is how to implement a 3rd party tiling service with \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.npmjs.com/package/react-map-gl\"}),\"react-map-gl\"),\":\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"Map\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"extends\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"React.Component\"),` {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"constructor\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"props\"),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),` = {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"viewport\"),`: {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"width\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'100%'\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"height\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"400\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"latitude\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"43.6532\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"longitude\"),\": -\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"79.3832\"),`,\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"zoom\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"2\"),`\n            }\n        }\n    }\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"render\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` (\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"xml\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"MapGL\"),`\n                `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"style\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{this.props.style}\"),`\n                `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"onViewportChange\"),\"=\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"{(viewport)\"),\" =\u003e\"),` this.setState({ viewport })}\n                mapStyle={mapStyle}\n                {...this.state.viewport}\n            \u003e\n                `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"Draw\"),`\n                /*`,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-attr\"}),\"...\"),`*/\n                /\u003e`),`\n            `,mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-tag\"}),\"\u003c/\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-name\"}),\"MapGL\"),\"\u003e\")),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/*...*/\"),`\n        )\n    }\n}\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),` mapStyle = {\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"version\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"8\"),`,\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"name\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"OSM Liberty\"'),`,\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"metadata\"'),`: {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"maputnik:license\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://github.com/maputnik/osm-liberty/blob/gh-pages/LICENSE.md\"'),`,\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"maputnik:renderer\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"mbgljs\"'),`\n  },\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"sources\"'),`: {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm a\"'),`: {\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"tiles\"'),\": [\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://a.tile.openstreetmap.org/{z}/{x}/{y}.png\"'),`],\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"minzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"maxzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"19\"),`\n    },\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm b\"'),`: {\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"tiles\"'),\": [\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://b.tile.openstreetmap.org/{z}/{x}/{y}.png\"'),`],\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"minzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"maxzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"19\"),`\n    },\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm c\"'),`: {\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"tiles\"'),\": [\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"https://c.tile.openstreetmap.org/{z}/{x}/{y}.png\"'),`],\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"minzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`,\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"maxzoom\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"19\"),`\n    }\n  },\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"layers\"'),`: [\n    { `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"id\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"A osm\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"source\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm a\"'),` },\n    { `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"id\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"B osm\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"source\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm b\"'),` },\n    { `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"id\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"C osm\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"type\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"raster\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"source\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm c\"'),` }\n  ],\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"id\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"osm-liberty\"'),`\n}\n\n`)),mdx(\"p\",null,\"Server-side, the fundamental principles are the same as when a user signs up for pickup. The front end sends a post request with the form information and the back end stores this in a database. Things are unique, however, with regards to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"password\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\" fields.\"),mdx(\"p\",null,\"Anyone with a sliver of security knowledge should know storing passwords in plain text is an awful idea. It is not only a liability in the event of a hack, it is also a liability in that the service owners can see user passwords at any time. People often re-use passwords which means a malicious party could use BottlesAgainstCOVID.org take control of more important accounts (email, banking, etc.).\"),mdx(\"p\",null,\"The current answer to this is storing salted and hashed passwords. \"),mdx(\"p\",null,\"Hashing is the process of doing complex math equations that cannot be undone. This transforms the password into a seemingly random jumble of characters. The process is, however, not random as the same input will produce the same output every time. An example of an irreversible math operation is XOR.\"),mdx(\"div\",a({},{className:\"math math-display\"}),mdx(\"span\",a({parentName:\"div\"},{className:\"katex-display\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\",display:\"block\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"1\"),mdx(\"mo\",{parentName:\"mrow\"},\"\\u2295\"),mdx(\"mn\",{parentName:\"mrow\"},\"1\"),mdx(\"mo\",{parentName:\"mrow\"},\"=\"),mdx(\"mn\",{parentName:\"mrow\"},\"0\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"1 \\\\oplus 1 = 0\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.72777em\",verticalAlign:\"-0.08333em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"1\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mbin\"}),\"\\u2295\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"1\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mrel\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\")))))),mdx(\"p\",null,\"... but ...\"),mdx(\"div\",a({},{className:\"math math-display\"}),mdx(\"span\",a({parentName:\"div\"},{className:\"katex-display\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\",display:\"block\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"0\"),mdx(\"mo\",{parentName:\"mrow\"},\"\\u2295\"),mdx(\"mn\",{parentName:\"mrow\"},\"0\"),mdx(\"mo\",{parentName:\"mrow\"},\"=\"),mdx(\"mn\",{parentName:\"mrow\"},\"0\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"0 \\\\oplus 0 = 0\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.72777em\",verticalAlign:\"-0.08333em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mbin\"}),\"\\u2295\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mrel\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\")))))),mdx(\"p\",null,\"So, given \",mdx(\"em\",{parentName:\"p\"},\"just\"),\" the result of \",mdx(\"span\",a({parentName:\"p\"},{className:\"math math-inline\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"0\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"0\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\"))))),\", it is impossible to work backwards and determine whether both inputs were \",mdx(\"span\",a({parentName:\"p\"},{className:\"math math-inline\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"0\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"0\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"0\"))))),\" or \",mdx(\"span\",a({parentName:\"p\"},{className:\"math math-inline\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"1\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"1\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"1\"))))),\".\"),mdx(\"p\",null,\"With bcrypt, this supposedly irreversible process repeats numerous times making it even more resource intensive to try and reverse the hashing operation. Even the most powerful supercomputers would take thousands of years to decrypt a single password.\"),mdx(\"p\",null,'Salting a password means adding some random chunk of data to the inputted user password. This means that hackers cannot compare stored passwords with known hashes. For example, the bcrypt hash of \"',mdx(\"inlineCode\",{parentName:\"p\"},\"hunter2\"),'\" (no salting) is:'),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-perl\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"$2b$10$3I4yPjW4IjTWnLe5IlCELePPPRfchtfn8mBcrLZxJl3rw.j6dpP7u\"'),`\n`)),mdx(\"p\",null,`A hacker could check for any accounts where the stored password value is this hash and know that user's password without needing to reverse the hash algorithm. Salting adds in some random text so that the hash for \"`,mdx(\"inlineCode\",{parentName:\"p\"},\"hunter2\"),'\" becomes something else.'),mdx(\"p\",null,\"Implementing this with \",mdx(\"a\",a({parentName:\"p\"},{href:\"http://mongoengine.org/\"}),\"mongoengine\"),\" and \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://flask-bcrypt.readthedocs.io/en/latest/\"}),\"flask_bcrypt\"),\" libraries looks like this:\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# User model declaration\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# This is an outline of what the user object looks like in the MongoDB database\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"from\"),\" flask_bcrypt \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"import\"),\" generate_password_hash \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"User\"),\"(db.Document): \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# class User extends db.Document\"),`\n    name = db.StringField(required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n    email = db.EmailField(required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),\", unique=\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# minimum length of a password is 6 characters\"),`\n    password = db.StringField(required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),\", min_length=\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"6\"),`)\n    geo_region = db.PolygonField(required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n    pickup_times = db.ListField(db.BooleanField(), required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n    header = db.StringField()\n    link_code = db.StringField(required=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),\", unique=\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n    drives = db.ListField(db.ReferenceField(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'PickupInfo'\"),`, reverse_delete_rule=db.PULL))\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),'# hash_password() is a method of the User class meaning all objects of type \"User\" can call this method on themselves'),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"hash_password\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n        self.password = generate_password_hash(self.password).decode(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'utf8'\"),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Flask post request\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),'# This is called when a post request is sent to the \"bottlesagainstcovid.org/api/auth/register\" endpoint'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"RegisterApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n        body = request.get_json()\n        user =  User(**body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"details\"'),`))\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Passwords are hashed as soon as they are received\"),`\n        user.hash_password()\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"Here the \",mdx(\"inlineCode\",{parentName:\"p\"},\"hash_password()\"),\" method does all the salting and hashing work. A secret environment file initialized as part of \",mdx(\"inlineCode\",{parentName:\"p\"},\"flask_bcrypt\"),\" contains the salt. Note that this salt \",mdx(\"em\",{parentName:\"p\"},\"should\"),\" be a different, randomly generated string for every user.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# in the main app.py flask file\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"from\"),\" flask_bcrypt \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"import\"),` Bcrypt\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\napp.config.from_envvar(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'ENV_FILE_LOCATION'\"),`)\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\nbcrypt = Bcrypt(app)\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"It is so easy to implement that there's \",mdx(\"strong\",{parentName:\"p\"},\"no excuse\"),\" for storing passwords in plain text. It is also important to note all transfers of data from the front end to the back end are secure through forced use of HTTPS.\"),mdx(\"p\",null,\"The next step is generating the bottle drive operator's unique \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\". \"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"RegisterApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n        user.generate_link_code()\n        user.save()\n        session[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),\"] = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"str\"),\"(user.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`)\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" redirect(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/list\"'),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` FieldDoesNotExist:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` SchemaValidationError\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` NotUniqueError:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` EmailAlreadyExistsError\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),\" Exception \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"as\"),` e:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InternalServerError\n`)),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# generate_link_code() method defined in the User class declaration\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"User\"),`(db.Document):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"generate_link_code\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n        good = `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_\"'),`\n        code = `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" i \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"range\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"5\"),`):\n            code += choice(good)\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (enchant.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-type\"}),\"Dict\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"en_US\"'),\").check(code) == \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),\"):\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"#make sure the code is not an english word\"),`\n            self.generate_link_code()\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            User.objects.get(link_code = code)`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"#throws an error if no object with the same link_code exits\"),`\n            self.generate_link_code()\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` DoesNotExist:\n            self.link_code = code\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"The post request calls the \",mdx(\"inlineCode\",{parentName:\"p\"},\"generate_link_code()\"),\" method. This method randomly picks 5 characters from 63 different URL safe options. It is important that the characters are URL safe to avoid hex values in the URL which make the links ugly. Next, the program checks to make sure the random collection of 5 characters is not a word (to completely avoid any profanity). There is also a check to make sure no other bottle drive operator has the same \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\". However, the chances of this happening are very low.\"),mdx(\"p\",null,\"Calculating the number of possible permutations given a 5-character sample from a 63-character set gives:\"),mdx(\"div\",a({},{className:\"math math-display\"}),mdx(\"span\",a({parentName:\"div\"},{className:\"katex-display\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\",display:\"block\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mi\",{parentName:\"mrow\"},\"P\"),mdx(\"mo\",{parentName:\"mrow\"},\"=\"),mdx(\"mfrac\",{parentName:\"mrow\"},mdx(\"mrow\",{parentName:\"mfrac\"},mdx(\"mn\",{parentName:\"mrow\"},\"63\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"!\")),mdx(\"mrow\",{parentName:\"mfrac\"},mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"(\"),mdx(\"mn\",{parentName:\"mrow\"},\"63\"),mdx(\"mo\",{parentName:\"mrow\"},\"\\u2212\"),mdx(\"mn\",{parentName:\"mrow\"},\"5\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\")\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"!\"))),mdx(\"mo\",{parentName:\"mrow\"},\"=\"),mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"461\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"640\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"P = \\\\frac{63!}{(63-5)!} = 843\\\\:461\\\\:640\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.68333em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mathnormal\",style:{marginRight:\"0.13889em\"}}),\"P\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mrel\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"2.30744em\",verticalAlign:\"-0.936em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mopen nulldelimiter\"})),mdx(\"span\",a({parentName:\"span\"},{className:\"mfrac\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-t vlist-t2\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"1.37144em\"}}),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-2.314em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mopen\"}),\"(\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"63\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mbin\"}),\"\\u2212\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"5\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose\"}),\")!\"))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.23em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"frac-line\",style:{borderBottomWidth:\"0.04em\"}}))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.677em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"63\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose\"}),\"!\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-s\"}),\"\\u200B\")),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"0.936em\"}}),mdx(\"span\",{parentName:\"span\"}))))),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose nulldelimiter\"}))),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mrel\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"461\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"640\")))))),mdx(\"p\",null,\"Subtracting the number of 5 letter English words (according to \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.quora.com/How-many-5-letter-words-exist/answer/Tom-Crosley-1\"}),\"this source\"),\") gives us:\"),mdx(\"div\",a({},{className:\"math math-display\"}),mdx(\"span\",a({parentName:\"div\"},{className:\"katex-display\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\",display:\"block\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"461\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"640\"),mdx(\"mo\",{parentName:\"mrow\"},\"\\u2212\"),mdx(\"mn\",{parentName:\"mrow\"},\"15\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"108\"),mdx(\"mo\",{parentName:\"mrow\"},\"=\"),mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"446\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"532\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"843\\\\:461\\\\:640 - 15\\\\:108 = 843\\\\:446\\\\:532\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.72777em\",verticalAlign:\"-0.08333em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"461\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"640\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mbin\"}),\"\\u2212\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"15\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"108\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mrel\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2777777777777778em\"}}))),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.64444em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"446\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"532\")))))),mdx(\"p\",null,\"This means that the odds of a collision occurring, given \",mdx(\"span\",a({parentName:\"p\"},{className:\"math math-inline\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mi\",{parentName:\"mrow\"},\"x\")),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"x\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"0.43056em\",verticalAlign:\"0em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mathnormal\"}),\"x\"))))),\" accounts created is:\"),mdx(\"div\",a({},{className:\"math math-display\"}),mdx(\"span\",a({parentName:\"div\"},{className:\"katex-display\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-mathml\"}),mdx(\"math\",a({parentName:\"span\"},{xmlns:\"http://www.w3.org/1998/Math/MathML\",display:\"block\"}),mdx(\"semantics\",{parentName:\"math\"},mdx(\"mrow\",{parentName:\"semantics\"},mdx(\"mfrac\",{parentName:\"mrow\"},mdx(\"mfrac\",{parentName:\"mfrac\"},mdx(\"mrow\",{parentName:\"mfrac\"},mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"446\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"532\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"!\")),mdx(\"mrow\",{parentName:\"mfrac\"},mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"(\"),mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"446\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"532\"),mdx(\"mo\",{parentName:\"mrow\"},\"\\u2212\"),mdx(\"mi\",{parentName:\"mrow\"},\"x\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\")\"),mdx(\"mo\",a({parentName:\"mrow\"},{stretchy:\"false\"}),\"!\"))),mdx(\"mrow\",{parentName:\"mfrac\"},mdx(\"mn\",{parentName:\"mrow\"},\"843\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"446\"),mdx(\"mtext\",{parentName:\"mrow\"},\"\\u2005\"),mdx(\"mn\",{parentName:\"mrow\"},\"53\"),mdx(\"msup\",{parentName:\"mrow\"},mdx(\"mn\",{parentName:\"msup\"},\"2\"),mdx(\"mi\",{parentName:\"msup\"},\"x\"))))),mdx(\"annotation\",a({parentName:\"semantics\"},{encoding:\"application/x-tex\"}),\"\\\\frac{\\\\frac{843\\\\:446\\\\:532!}{(843\\\\:446\\\\:532-x)!}}{843\\\\:446\\\\:532^x}\")))),mdx(\"span\",a({parentName:\"span\"},{className:\"katex-html\",\"aria-hidden\":\"true\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"base\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"strut\",style:{height:\"2.476108em\",verticalAlign:\"-0.686em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mopen nulldelimiter\"})),mdx(\"span\",a({parentName:\"span\"},{className:\"mfrac\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-t vlist-t2\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"1.790108em\"}}),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-2.314em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"446\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace\",style:{marginRight:\"0.2222222222222222em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"53\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),\"2\"),mdx(\"span\",a({parentName:\"span\"},{className:\"msupsub\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-t\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"0.590392em\"}}),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-2.9890000000000003em\",marginRight:\"0.05em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"2.7em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"sizing reset-size6 size3 mtight\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mathnormal mtight\"}),\"x\")))))))))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.23em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"frac-line\",style:{borderBottomWidth:\"0.04em\"}}))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.91em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mopen nulldelimiter\"})),mdx(\"span\",a({parentName:\"span\"},{className:\"mfrac\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-t vlist-t2\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"0.8801079999999999em\"}}),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-2.655em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"sizing reset-size6 size3 mtight\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mopen mtight\"}),\"(\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace mtight\",style:{marginRight:\"0.26022222222222224em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"446\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace mtight\",style:{marginRight:\"0.26022222222222224em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"532\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mbin mtight\"}),\"\\u2212\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mathnormal mtight\"}),\"x\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose mtight\"}),\")!\")))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.23em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"frac-line\",style:{borderBottomWidth:\"0.04em\"}}))),mdx(\"span\",a({parentName:\"span\"},{style:{top:\"-3.394em\"}}),mdx(\"span\",a({parentName:\"span\"},{className:\"pstrut\",style:{height:\"3em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"sizing reset-size6 size3 mtight\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"843\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace mtight\",style:{marginRight:\"0.26022222222222224em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"446\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mspace mtight\",style:{marginRight:\"0.26022222222222224em\"}})),mdx(\"span\",a({parentName:\"span\"},{className:\"mord mtight\"}),\"532\"),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose mtight\"}),\"!\"))))),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-s\"}),\"\\u200B\")),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"0.52em\"}}),mdx(\"span\",{parentName:\"span\"}))))),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose nulldelimiter\"})))))),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-s\"}),\"\\u200B\")),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist-r\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"vlist\",style:{height:\"0.686em\"}}),mdx(\"span\",{parentName:\"span\"}))))),mdx(\"span\",a({parentName:\"span\"},{className:\"mclose nulldelimiter\"})))))))),mdx(\"p\",null,\"This is an extremely small number for any reasonable number of user accounts. Nevertheless, the code is there ... just in case.\"),mdx(\"p\",null,\"Finally, the website rejects any operators already signed up or with too short a password.\"),mdx(\"h3\",null,\"Logging in\"),mdx(\"p\",null,\"Login is another feature exclusive to bottle drive operators. The login screen simply sends a post request to the /api/auth/login endpoint and redirects to the page provided by the server. The page shows an error message if the email or password is invalid.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"handleLoginSubmit\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"event\"),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"var\"),\" loginData = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-constant\"}),\"JSON\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"stringify\"),`({\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"email\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"email\"),`,\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"password\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"password\"),`\n    })\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/api/auth/login\"'),`, requestOptions)\n        .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"response\"),\" =\u003e\"),` {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"status\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"200\"),`) {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"replace\"),\"(response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"url\"),`)\n            } `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"status\"),\" === \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"401\"),`) {\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"setState\"),\"({ \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"email\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"password\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"unauthorized\"),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"true\"),` })\n            }\n        })\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n}\n`)),mdx(\"p\",null,\"The response URL replaces the current URL. This means the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/login\"),\" page is not kept in the browser history. After logging in, the bottle drive operator would have no need to log in again, so this behaviour is intentional. \"),mdx(\"p\",null,\"Furthermore, the login page will redirect automatically to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/list\"),\" page when logged in. Upon loading the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/login\"),\" page, the front end sends a request to the back end checking if the user is logged in. The server responds with a \",mdx(\"inlineCode\",{parentName:\"p\"},\"true\"),\" or \",mdx(\"inlineCode\",{parentName:\"p\"},\"false\"),\". This uses the \",mdx(\"inlineCode\",{parentName:\"p\"},\"session\"),\" module in the flask library. Each user receives a cookie upon signing in. Checking for a valid cookie occurs each time the user tries to access a restricted page. The same checking service redirects a logged-out user to the login page.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"// Front end request code\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"// ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"componentDidMount\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/api/auth/login\"'),`)\n    .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"response\"),\" =\u003e\"),\" response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`())\n    .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"result\"),\" =\u003e\"),\" result \u0026\u0026 \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"window\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"location\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"replace\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/list\"'),`))\n    .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"catch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"error\"),\" =\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"console\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"log\"),`(error))\n}\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"// ...\"),`\n`)),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Back end response code\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"LoginApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),` session:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" jsonify(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`)\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),`:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" jsonify(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"False\"),`)\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),\" Exception \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"as\"),` e:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InternalServerError\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"The server stores the email \u0026 salted+hashed password, so authentication happens on the back end. The important part here is the \",mdx(\"inlineCode\",{parentName:\"p\"},\"user.check_password()\"),\" method. This performs the exact same salt+hash operation used when creating the password. Login is successful when this result matches the stored salted+hashed password. This is because only the correct password will ever produce a result matching the stored password. If you are more interested in hashing (or you find this short explanation difficult to understand) check out this \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.youtube.com/watch?v=yoMOAIzBSpY\"}),\"video\"),\" and some of the other videos suggested towards the end.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Post request\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"LoginApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n        body = request.get_json()\n        user = User.objects.get(email=body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'email'\"),`))\n        authorized = user.check_password(body.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'password'\"),`))\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"not\"),` authorized:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` UnauthorizedError\n        session[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),\"] = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"str\"),\"(user.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`)\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" redirect(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/list\"'),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` (UnauthorizedError, DoesNotExist):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` UnauthorizedError\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),\" Exception \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"as\"),` e:\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InternalServerError\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Check password method in the User class\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"check_password\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self, password\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` check_password_hash(self.password, password)\n`)),mdx(\"h3\",null,\"Adding new bottle drives\"),mdx(\"p\",null,\"Adding bottle drives happens on the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/list\"),\" page.\"),mdx(\"p\",null,mdx(\"img\",a({parentName:\"p\"},{src:\"/assets/img/bottles-against-covid/list-page.png\",alt:\"list page\"}))),mdx(\"p\",null,\"To add a bottle drive, the operator simply selects a date, types in a maximum number of boxes, and presses the \\u2795 button. Filling out these fields automatically updates the \",mdx(\"inlineCode\",{parentName:\"p\"},\"state\"),\" object. Pressing the button sends a post request to the back end with the necessary information. Upon successfully sending the data, the page reloads the table of drives. This makes the new drive visible to the operator.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-js\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"sendNewDrive\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"})),`) {\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"const\"),\" driveData = \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-constant\"}),\"JSON\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"stringify\"),`({\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"newDrive\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"date\"),`,\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"crates_limit\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"state\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"newDrive\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-property\"}),\"crates_limit\"),`\n    })\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"fetch\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"/api/list\"'),`, requestOptions)\n        .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-params\"}),\"response\"),\" =\u003e\"),\" response.\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"json\"),`())\n        .`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"then\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-function\"}),\"() =\u003e\"),` {\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"loadDrives\"),`()\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-variable hljs-language\"}),\"this\"),\".\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"setState\"),\"({ \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-attr\"}),\"newDrive\"),\": { \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"crates_limit\"'),\": \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"\"'),` } })\n        })\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"/* ... */\"),`\n}\n`)),mdx(\"p\",null,\"The back end only creates drives that start tomorrow at the earliest. It rejects any request on a past date or the current date. Also, of note is the addition of the drive object id to the user object. This makes the list of the operator's drives accessible by both searching the \",mdx(\"inlineCode\",{parentName:\"p\"},\"link_code\"),\" and inspecting the specific user object. Inspecting the object takes less time than searching through the entire database of drives. Both paths produce the exact same object; one is not simply a copy of the other. This is also part of a security component where another user cannot delete someone else's drive. Only the creator of a drive can delete it. \"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# Back end to create a new bottle drive object\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"ListDriveApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),\"):\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"#to modify a bottle drive instance\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"post\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),\"): \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# make a new drive instance\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),` session:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n                user_id = session[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),`]\n                body = request.get_json()\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" datetime.strptime(body[\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"date\"'),\"], \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"%Y-%m-%d\"'),`) \u003c datetime.now():\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` ValidationError\n                user = User.objects.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"id\"),`=user_id)\n                pickupInfo =  PickupInfo(**body, created_by=user, active=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-literal\"}),\"True\"),`, link_code=user.link_code )\n                pickupInfo.save()\n                user.update(push__drives=pickupInfo)\n                user.save()\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"success\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"200\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),\" Exception \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"as\"),` e:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),`:\n            abort(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"403\"),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"unauthorized\"'),`)\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"p\",null,\"The other part of the deletion restriction is registering a delete rule in the MongoDB model declarations.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\nUser.register_delete_rule(PickupInfo, `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'created_by'\"),`, db.CASCADE)\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`)),mdx(\"h3\",null,\"Making pickup day easy\"),mdx(\"p\",null,\"Pickup day is extremely easy because the bottle drive operator can download the address and other pickup info of each person registered for a specific bottle drive. All the operator needs to do is click the \\u2B07\\uFE0F (download) button next to their bottle drive of choice. This saves a .csv file with each registrant's name, email, address, neighbourhood, number of boxes to pick up, and note. The addition of the neighbourhood field was a suggestion by St. Joe's community campaign officer Kathy Richmond. Listing the neighbourhood makes it easier for operators to know which houses are close to each other and plan the order of pickups accordingly.\"),mdx(\"p\",null,\"Interestingly, the server never stores the .csv file. It instead streams the file to the user. This cuts down on disk use. Streaming works through use of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"yield\"),\" keyword. This allows a function/method (in this case \",mdx(\"inlineCode\",{parentName:\"p\"},\"generate()\"),\") to return multiple values before halting. Each of these values are then sent to the end user.\"),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{className:\"hljs language-python\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"import\"),` csv\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"class\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class\"}),\"DownloadAddressesApi\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-class hljs-inherited\"}),\"Resource\"),`):\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"get\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"self\"),`):\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),` session:\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"try\"),`:\n                user_id = session[`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'userId'\"),`]\n                date = request.args.get(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'date'\"),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"''\"),`)\n                pickupInfo = PickupInfo.objects.get(created_by=user_id, date=date)\n\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"def\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-title hljs-function\"}),\"generate\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-params\"}),\"pickupInfo\"),`):\n                    data = StringIO()\n                    w = csv.writer(data)\n\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# write header\"),`\n                    w.writerow((`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Name\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Address\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Neighbourhood\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"e-mail\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"boxes\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"message\"'),`))\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"yield\"),` data.getvalue()\n                    data.seek(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`)\n                    data.truncate(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`)\n\n                    `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"for\"),\" item \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"in\"),` pickupInfo.addresses:\n                        w.writerow((\n                            item.name,\n                            item.homeAddress,\n                            item.neighbourhood,\n                            item.email,\n                            item.crates,\n                            item.message\n                        ))\n                        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"yield\"),` data.getvalue()\n                        data.seek(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`)\n                        data.truncate(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`)\n\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# stream the response as the data is generated\"),`\n                response = Response(generate(pickupInfo), mimetype=`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),\"'text/csv'\"),`)\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-comment\"}),\"# add a filename\"),`\n                response.headers.`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-built_in\"}),\"set\"),\"(\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"Content-Disposition\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"attachment\"'),\", filename=\",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'f\"',mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-subst\"}),\"{pickupInfo.date.strftime(\",mdx(\"span\",a({parentName:\"span\"},{className:\"hljs-string\"}),\"'%Y-%m-%d'\"),\")}\"),'-pickup-addresses.csv\"'),`)\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),` response\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"except\"),` Exception:\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"raise\"),` InternalServerError\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),`:\n            abort(`,mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-number\"}),\"403\"),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"hljs-string\"}),'\"unauthorized\"'),`)\n`)),mdx(\"h2\",null,\"Reflecting on the build process\"),mdx(\"h3\",null,\"React Front end\"),mdx(\"p\",null,\"My experience with React Native at my job last summer and DeltaHacks IV was invaluable for this part. However, I did learn a lot of new things about React and JS from this project. \"),mdx(\"p\",null,\"I think my biggest growth was in design. This is the first website I have made where the visual aspects were considered. All my prior layout experience was with React Native, which is a little bit different from ReactJS. I also feel like I garnered a better understanding of React and JS this time compared to last. \"),mdx(\"p\",null,\"If I were to do this again, I might use something like \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://github.com/preactjs/preact\"}),\"Preact\"),\". I feel as if I have left much of the capabilities of React on the table, and that it may have been overkill.\"),mdx(\"p\",null,\"Also, next time I would use hooks. I have started using hooks on another project and they are \",mdx(\"strong\",{parentName:\"p\"},mdx(\"em\",{parentName:\"strong\"},\"significantly\")),\" easier to use than classes. I am not sure why I was so afraid to use them.\"),mdx(\"h3\",null,\"Flask Back End\"),mdx(\"p\",null,\"This part of the build process was almost entirely foreign to me. I had some experience with basic Flask development after my DeltaHacks IV project, but otherwise I was in the dark. I was able to build the foundations for my website thanks to the great tutorials available online, specifically \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://blog.miguelgrinberg.com/post/how-to-deploy-a-react--flask-project\"}),\"this one\"),\", and \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://dev.to/paurakhsharma/flask-rest-api-part-1-using-mongodb-with-flask-3g7d\"}),\"this one\"),\".\"),mdx(\"p\",null,\"If I were to do this part again, I would likely choose a different framework than Flask. I have started another project (it is a secret right now) using \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://fastapi.tiangolo.com/\"}),\"FastAPI\"),\". I find it \",mdx(\"em\",{parentName:\"p\"},\"much\"),\" nicer to use than Flask.\"),mdx(\"h3\",null,\"MongoDB Database\"),mdx(\"p\",null,\"I will say, using MongoDB with mongoengine was a joy. It was very easy to use and the built-in geo-query capabilities of MongoDB made the search feature on the website's main page a snap.\"),mdx(\"h3\",null,\"Writing this blog post\"),mdx(\"p\",null,\"I have not done a blog post like this in a long time. It took an immense amount of time and is likely too long for anyone to read to completion ... but I did catch a lot of fringe mistakes while writing it. Nothing program breaking (as these are easier to notice while writing code), but I found a lot of code that was not needed anymore and made things more complex. It has also helped me reflect on what I learned from this project and where I can improve.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"feature-img":"/assets/img/bottles-against-covid/day-1-bottle-drive.jpg"}},"__N_SSG":true},"page":"/blog/[postName]","query":{"postName":"2020-08-30-Bottles-Against-COVID"},"buildId":"SyBJKaoNCzre2I37ptT8g","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>